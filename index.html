<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="./manifest.json">
    <title>FP DAM Gestor - Completo</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f9fafb; 
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Loading Screen */
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2563eb, #9333ea); 
                   display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; }
        .loading.hide { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; 
                   border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Save Indicator */
        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: #22c55e; color: white; 
                         padding: 10px 20px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                         opacity: 0; transition: opacity 0.3s; z-index: 999; }
        .save-indicator.show { opacity: 1; }
        
        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #2563eb, #9333ea); color: white; padding: 25px 20px; 
                 text-align: center; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header h1 { font-size: 26px; margin-bottom: 10px; }
        .header .time { font-size: 28px; font-weight: bold; margin-top: 10px; font-family: monospace; }
        .storage-badge { background: rgba(34, 197, 94, 0.3); border: 2px solid rgba(34, 197, 94, 0.6); 
                        padding: 8px 16px; border-radius: 20px; font-size: 13px; margin-top: 10px; display: inline-block; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { font-size: 20px; margin-bottom: 15px; color: #1f2937; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
               cursor: pointer; margin-bottom: 10px; transition: all 0.3s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #9333ea); color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        
        /* Activity Items */
        .activity-item { padding: 15px; background: #f3f4f6; border-radius: 12px; margin-bottom: 10px; 
                        display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; }
        .activity-item:hover { background: #e5e7eb; }
        .activity-item.completed { background: #d1fae5; border: 2px solid #22c55e; }
        
        .checkbox { width: 30px; height: 30px; min-width: 30px; border: 3px solid #9ca3af; border-radius: 50%;
                   display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .checkbox.checked { background: #22c55e; border-color: #22c55e; }
        .checkbox.checked::after { content: '‚úì'; color: white; font-weight: bold; font-size: 20px; }
        
        .activity-content { flex: 1; }
        .activity-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .activity-time { font-size: 13px; color: #6b7280; }
        
        /* Badges */
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; color: white; }
        .badge-red { background: #ef4444; }
        .badge-yellow { background: #eab308; }
        .badge-green { background: #22c55e; }
        .badge-blue { background: #3b82f6; }
        .badge-purple { background: #a855f7; }
        .badge-orange { background: #f97316; }
        
        /* Progress Bar */
        .progress-bar { width: 100%; height: 12px; background: #e5e7eb; border-radius: 20px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #9333ea); transition: width 0.5s; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-card { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 20px; 
                    border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 13px; opacity: 0.9; }
        
        /* Forms */
        select, input[type="date"], input[type="text"], input[type="time"], textarea {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;
            margin-bottom: 15px; font-family: inherit; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
        
        /* Delivery Items */
        .delivery-item { padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #e5e7eb; }
        .delivery-item.urgent { background: #fef2f2; border-color: #ef4444; }
        .delivery-header { display: flex; justify-content: between; align-items: start; margin-bottom: 10px; }
        .delivery-boost { background: #fff7ed; border: 2px solid #f97316; padding: 12px; border-radius: 10px; margin-top: 10px; }
        
        /* Week View */
        .week-days { display: grid; gap: 12px; }
        .day-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .day-card.today { border: 3px solid #3b82f6; }
        .day-card.sunday { background: #f0fdf4; border: 2px solid #22c55e; }
        
        /* Navigation */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; 
                  background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-btn { background: #f3f4f6; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .nav-btn:hover { background: #e5e7eb; }
        
        /* Utility */
        .hide { display: none !important; }
        .text-center { text-align: center; }
        .text-gray { color: #6b7280; }
        .text-sm { font-size: 14px; }
        .mt-2 { margin-top: 8px; }
        .mb-2 { margin-bottom: 8px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                        display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: white; border-radius: 20px; padding: 25px; max-width: 500px; width: 100%; 
                max-height: 80vh; overflow-y: auto; }
        .modal h3 { font-size: 22px; margin-bottom: 15px; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 28px; cursor: pointer; color: #6b7280; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px;">FP DAM Gestor</h2>
        <p style="margin-top: 10px; opacity: 0.9;">Cargando aplicaci√≥n...</p>
        <p style="margin-top: 5px; font-size: 14px;">üíæ Almacenamiento Permanente</p>
    </div>
    
    <!-- Save Indicator -->
    <div id="save-indicator" class="save-indicator">üíæ Guardado</div>
    
    <!-- App Container -->
    <div id="app" class="hide"></div>
    
    <script>
        console.log('üöÄ FP DAM Gestor - Versi√≥n JavaScript Vanilla Completa');
        console.log('üíæ Almacenamiento: Firebase + localStorage permanente');
        
        // =================================================================
        // FIREBASE CONFIGURATION
        // =================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDemoKey123456789",
            authDomain: "fp-dam-gestor.firebaseapp.com",
            projectId: "fp-dam-gestor",
            storageBucket: "fp-dam-gestor.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // Initialize Firebase
        let db = null;
        let firebaseInitialized = false;
        
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase inicializado');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase no disponible, usando solo localStorage:', error);
            firebaseInitialized = false;
        }
        
        // =================================================================
        // DATOS BASE
        // =================================================================
        
        const BASE_ACTIVITIES = {
            prog: { id: 'prog', name: 'Programaci√≥n', type: 'fp-critical', color: 'badge-red',
                    scheduleNoWork: { start: '08:00', end: '10:00', hours: '2h' },
                    scheduleWithWork: { start: '07:30', end: '08:30', hours: '1h' }, priority: 1 },
            bd: { id: 'bd', name: 'Base de Datos', type: 'fp-critical', color: 'badge-red',
                  scheduleNoWork: { start: '10:15', end: '11:45', hours: '1.5h' },
                  scheduleWithWork: { start: '17:30', end: '18:30', hours: '1h' }, priority: 1 },
            ingles: { id: 'ingles', name: 'Ingl√©s', type: 'learning', color: 'badge-purple',
                      scheduleNoWork: { start: '11:45', end: '12:15', hours: '0.5h' },
                      scheduleWithWork: { start: '20:30', end: '20:50', hours: '0.33h' }, priority: 2, weekDays: [1,2,4] },
            ias: { id: 'ias', name: 'Estudiar IAs', type: 'learning', color: 'badge-purple',
                   scheduleNoWork: { start: '12:15', end: '12:45', hours: '0.5h' },
                   scheduleWithWork: { start: '19:30', end: '20:00', hours: '0.5h' }, priority: 2, weekDays: [1,3,5] },
            seo: { id: 'seo', name: 'Estudiar SEO', type: 'learning', color: 'badge-purple',
                   scheduleNoWork: { start: '12:45', end: '13:15', hours: '0.5h' },
                   scheduleWithWork: { start: '20:00', end: '20:30', hours: '0.5h' }, priority: 2, weekDays: [2,4,5] },
            si: { id: 'si', name: 'Sistemas Inform√°ticos', type: 'fp-important', color: 'badge-yellow',
                  scheduleNoWork: { start: '15:00', end: '16:00', hours: '1h' },
                  scheduleWithWork: { start: '18:30', end: '19:00', hours: '0.5h' }, priority: 2 },
            ed: { id: 'ed', name: 'Entornos Desarrollo', type: 'fp-important', color: 'badge-yellow',
                  scheduleNoWork: { start: '16:00', end: '16:45', hours: '0.75h' },
                  scheduleWithWork: { start: '20:30', end: '21:00', hours: '0.5h' }, priority: 2 },
            lm: { id: 'lm', name: 'Lenguajes Marcas', type: 'fp-light', color: 'badge-green',
                  scheduleNoWork: { start: '16:45', end: '17:30', hours: '0.75h' },
                  scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            digi: { id: 'digi', name: 'Digitalizaci√≥n', type: 'fp-light', color: 'badge-green',
                    scheduleNoWork: { start: '17:30', end: '18:00', hours: '0.5h' },
                    scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            ipo: { id: 'ipo', name: 'Itinerario IPO', type: 'fp-light', color: 'badge-green',
                   scheduleNoWork: { start: '18:00', end: '18:30', hours: '0.5h' },
                   scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            trabajo: { id: 'trabajo', name: 'B√∫squeda Trabajo', type: 'personal', color: 'badge-blue',
                       scheduleNoWork: { start: '18:30', end: '20:00', hours: '1.5h' },
                       scheduleWithWork: { start: '', end: '', hours: '' }, priority: 2, onlyNoWork: true },
            tiempolibre: { id: 'tiempolibre', name: 'Tiempo Libre', type: 'personal', color: 'badge-blue',
                           scheduleNoWork: { start: '', end: '', hours: '' },
                           scheduleWithWork: { start: '', end: '', hours: '' }, priority: 3, onlyNoWork: true },
            revision: { id: 'revision', name: 'Revisi√≥n del D√≠a', type: 'personal', color: 'badge-blue',
                        scheduleNoWork: { start: '20:00', end: '21:00', hours: '1h' },
                        scheduleWithWork: { start: '', end: '', hours: '' }, priority: 2, onlyNoWork: true },
            cena: { id: 'cena', name: 'Cena', type: 'personal', color: 'badge-orange',
                    scheduleNoWork: { start: '21:00', end: '22:00', hours: '1h' },
                    scheduleWithWork: { start: '22:00', end: '23:00', hours: '1h' }, priority: 5, fixed: true },
            familia: { id: 'familia', name: 'Pareja/Familia', type: 'personal', color: 'badge-purple',
                       scheduleNoWork: { start: '22:00', end: '23:00', hours: '1h' },
                       scheduleWithWork: { start: '21:00', end: '22:00', hours: '1h' }, priority: 5, fixed: true },
            nocturna: { id: 'nocturna', name: 'Rutina Nocturna', type: 'personal', color: 'badge-blue',
                        scheduleNoWork: { start: '23:00', end: '00:00', hours: '1h' },
                        scheduleWithWork: { start: '23:00', end: '00:00', hours: '1h' }, priority: 5, fixed: true },
            almuerzo: { id: 'almuerzo', name: 'Almuerzo + Descanso', type: 'break', color: 'badge-orange',
                        scheduleNoWork: { start: '13:15', end: '15:00', hours: '1.75h' },
                        scheduleWithWork: { start: '13:00', end: '14:00', hours: '1h' }, priority: 5, fixed: true }
        };
        
        // =================================================================
        // ESTADO GLOBAL
        // =================================================================
        
        let STATE = {
            currentView: 'setup',
            setupStep: 1,
            hasWork: null,
            allActivities: {...BASE_ACTIVITIES},
            activeActivities: [],
            completedTasks: {},
            deliveries: [],
            currentDate: new Date(),
            notifiedActivities: new Set()
        };
        
        // =================================================================
        // ALMACENAMIENTO PERMANENTE
        // =================================================================
        
        function saveData() {
            try {
                const dataToSave = {
                    hasWork: STATE.hasWork,
                    allActivities: STATE.allActivities,
                    activeActivities: STATE.activeActivities,
                    completedTasks: STATE.completedTasks,
                    deliveries: STATE.deliveries,
                    lastSaved: new Date().toISOString(),
                    version: '4.0-firebase'
                };
                
                // Guardar en localStorage (backup local)
                localStorage.setItem('fpDamApp', JSON.stringify(dataToSave));
                
                // Guardar en Firebase (sincronizaci√≥n)
                if (firebaseInitialized && db) {
                    const userId = getOrCreateUserId();
                    db.collection('users').doc(userId).set(dataToSave, { merge: true })
                        .then(() => {
                            console.log('‚òÅÔ∏è Sincronizado con Firebase');
                        })
                        .catch((error) => {
                            console.warn('‚ö†Ô∏è Error al sincronizar Firebase:', error);
                        });
                }
                
                showSaveIndicator();
                console.log('üíæ Datos guardados:', new Date().toLocaleTimeString());
                return true;
            } catch (e) {
                console.error('‚ùå Error al guardar:', e);
                alert('Error al guardar datos. Verifica el almacenamiento.');
                return false;
            }
        }
        
        async function loadData() {
            try {
                // Intentar cargar desde Firebase primero
                if (firebaseInitialized && db) {
                    const userId = getOrCreateUserId();
                    try {
                        const doc = await db.collection('users').doc(userId).get();
                        if (doc.exists) {
                            const data = doc.data();
                            STATE.hasWork = data.hasWork;
                            STATE.allActivities = data.allActivities || {...BASE_ACTIVITIES};
                            STATE.activeActivities = data.activeActivities || [];
                            STATE.completedTasks = data.completedTasks || {};
                            STATE.deliveries = (data.deliveries || []).map(d => ({
                                ...d,
                                date: new Date(d.date),
                                created: new Date(d.created || Date.now())
                            }));
                            
                            // Guardar en localStorage como backup
                            localStorage.setItem('fpDamApp', JSON.stringify(data));
                            
                            if (STATE.hasWork !== null) {
                                STATE.currentView = 'home';
                            }
                            console.log('‚úÖ Datos cargados desde Firebase');
                            return true;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error al cargar desde Firebase, usando localStorage:', error);
                    }
                }
                
                // Fallback a localStorage
                const saved = localStorage.getItem('fpDamApp');
                if (saved) {
                    const data = JSON.parse(saved);
                    STATE.hasWork = data.hasWork;
                    STATE.allActivities = data.allActivities || {...BASE_ACTIVITIES};
                    STATE.activeActivities = data.activeActivities || [];
                    STATE.completedTasks = data.completedTasks || {};
                    STATE.deliveries = (data.deliveries || []).map(d => ({
                        ...d,
                        date: new Date(d.date),
                        created: new Date(d.created || Date.now())
                    }));
                    
                    if (STATE.hasWork !== null) {
                        STATE.currentView = 'home';
                    }
                    console.log('‚úÖ Datos cargados desde localStorage');
                    return true;
                }
                console.log('‚ÑπÔ∏è No hay datos guardados');
                return false;
            } catch (e) {
                console.error('‚ùå Error al cargar:', e);
                return false;
            }
        }
        
        function getOrCreateUserId() {
            let userId = localStorage.getItem('fpDamUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('fpDamUserId', userId);
                console.log('üÜî Nuevo ID de usuario creado:', userId);
            }
            return userId;
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }
        
        function downloadBackup() {
            try {
                const data = {
                    hasWork: STATE.hasWork,
                    allActivities: STATE.allActivities,
                    activeActivities: STATE.activeActivities,
                    completedTasks: STATE.completedTasks,
                    deliveries: STATE.deliveries,
                    exportDate: new Date().toISOString(),
                    version: '3.0-backup'
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fp-dam-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('‚úÖ Backup descargado correctamente\n\nüí° S√∫belo a Google Drive para guardarlo en la nube');
            } catch (e) {
                alert('‚ùå Error al crear backup: ' + e.message);
            }
        }
        
        function uploadToDrive() {
            downloadBackup();
            setTimeout(() => {
                window.open('https://drive.google.com/drive/my-drive', '_blank');
            }, 500);
        }
        
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.hasWork === undefined || !data.allActivities || !data.activeActivities) {
                            throw new Error('Estructura de backup inv√°lida');
                        }
                        
                        STATE.hasWork = data.hasWork;
                        STATE.allActivities = data.allActivities;
                        STATE.activeActivities = data.activeActivities;
                        STATE.completedTasks = data.completedTasks || {};
                        STATE.deliveries = (data.deliveries || []).map(d => ({
                            ...d,
                            date: new Date(d.date),
                            created: new Date(d.created || Date.now())
                        }));
                        
                        saveData();
                        STATE.currentView = 'home';
                        render();
                        alert('‚úÖ Backup restaurado correctamente');
                    } catch (error) {
                        alert('‚ùå Error al restaurar backup:\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function restoreFromDrive() {
            if (confirm('Se abrir√° Google Drive.\n\n1. Descarga tu backup (.json) de Drive\n2. Luego usa "Restaurar desde Archivo Local"\n\n¬øAbrir Drive?')) {
                window.open('https://drive.google.com/drive/my-drive', '_blank');
            }
        }
        
        function resetApp() {
            if (confirm('‚ö†Ô∏è Esto borrar√° TODOS los datos permanentemente. ¬øEst√°s seguro?')) {
                if (confirm('‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Se perder√°n todas tus configuraciones. ¬øContinuar?')) {
                    localStorage.removeItem('fpDamApp');
                    STATE = {
                        currentView: 'setup',
                        setupStep: 1,
                        hasWork: null,
                        allActivities: {...BASE_ACTIVITIES},
                        activeActivities: [],
                        completedTasks: {},
                        deliveries: [],
                        currentDate: new Date(),
                        notifiedActivities: new Set()
                    };
                    render();
                    alert('‚úÖ Configuraci√≥n reiniciada');
                }
            }
        }
        
        // =================================================================
        // FUNCIONES AUXILIARES
        // =================================================================
        
        function formatDate(date) {
            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${dias[date.getDay()]} ${date.getDate()} de ${meses[date.getMonth()]}`;
        }
        
        function getDateKey(date) {
            return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        }
        
        function toggleTask(activityId) {
            const dateKey = getDateKey(STATE.currentDate);
            if (!STATE.completedTasks[dateKey]) {
                STATE.completedTasks[dateKey] = {};
            }
            STATE.completedTasks[dateKey][activityId] = !STATE.completedTasks[dateKey][activityId];
            saveData();
            render();
        }
        
        function isTaskCompleted(activityId) {
            const dateKey = getDateKey(STATE.currentDate);
            return STATE.completedTasks[dateKey]?.[activityId] || false;
        }
        
        function getProgress(date = STATE.currentDate) {
            const dateKey = getDateKey(date);
            const tasks = STATE.completedTasks[dateKey] || {};
            const completed = Object.values(tasks).filter(Boolean).length;
            const total = STATE.activeActivities.length;
            return total === 0 ? 0 : Math.round((completed / total) * 100);
        }
        
        function getTotalCompleted() {
            let total = 0;
            Object.values(STATE.completedTasks).forEach(dayTasks => {
                total += Object.values(dayTasks).filter(Boolean).length;
            });
            return total;
        }
        
        function getDaysUntilDelivery(deliveryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const delivery = new Date(deliveryDate);
            delivery.setHours(0, 0, 0, 0);
            const diff = delivery - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        function addDelivery(subject, date, description) {
            if (!subject || !date || !description) {
                alert('‚ö†Ô∏è Por favor completa todos los campos');
                return;
            }
            
            const newDelivery = {
                id: Date.now(),
                subject,
                date: new Date(date),
                description,
                created: new Date()
            };
            
            STATE.deliveries.push(newDelivery);
            STATE.deliveries.sort((a, b) => a.date - b.date);
            
            const daysUntil = getDaysUntilDelivery(date);
            if (daysUntil >= 0 && daysUntil <= 3) {
                applyUrgentBoost();
                alert('‚úÖ Entrega agregada!\n\nüî• Como quedan ‚â§3 d√≠as, el horario se ha ajustado autom√°ticamente');
            } else {
                alert('‚úÖ Entrega agregada correctamente');
            }
            
            saveData();
            render();
        }
        
        function deleteDelivery(id) {
            if (confirm('¬øEliminar esta entrega?')) {
                STATE.deliveries = STATE.deliveries.filter(d => d.id !== id);
                applyUrgentBoost();
                saveData();
                render();
            }
        }
        
        function applyUrgentBoost() {
            console.log('üîÑ Redistribuyendo horarios...');
            const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
            
            // PASO 0: Restaurar TODO desde BASE_ACTIVITIES
            Object.keys(BASE_ACTIVITIES).forEach(key => {
                const baseAct = BASE_ACTIVITIES[key];
                const stateAct = STATE.allActivities[key];
                if (stateAct && baseAct[schedule]) {
                    stateAct[schedule] = JSON.parse(JSON.stringify(baseAct[schedule]));
                    stateAct.boosted = false;
                    stateAct.boostedMultiplier = null;
                    stateAct.boostedBaseHours = null;
                }
            });
            
            // Detectar entregas urgentes
            const urgentDeliveries = STATE.deliveries.filter(d => {
                const daysUntil = getDaysUntilDelivery(d.date);
                return daysUntil >= 0 && daysUntil <= 3;
            });
            
            if (urgentDeliveries.length === 0) {
                console.log('‚úÖ Sin entregas urgentes - horario normal');
                return;
            }
            
            console.log(`üî• ${urgentDeliveries.length} entrega(s) urgente(s) detectada(s)`);
            
            // Calcular tiempo extra necesario
            let totalExtraNeeded = 0;
            const boostedActivities = [];
            
            urgentDeliveries.forEach(delivery => {
                const activity = STATE.allActivities[delivery.subject];
                if (!activity) return;
                const sched = activity[schedule];
                if (!sched || sched.hours === 'Var') return;
                
                const baseHours = parseFloat(BASE_ACTIVITIES[delivery.subject][schedule].hours);
                if (isNaN(baseHours)) return;
                
                const daysUntil = getDaysUntilDelivery(delivery.date);
                const multiplier = daysUntil === 0 ? 3 : daysUntil === 1 ? 2.5 : 2;
                const neededHours = baseHours * multiplier;
                const extraNeeded = neededHours - baseHours;
                totalExtraNeeded += extraNeeded;
                
                boostedActivities.push({
                    id: delivery.subject,
                    activity: activity,
                    baseHours: baseHours,
                    newHours: neededHours,
                    multiplier: multiplier
                });
                
                console.log(`üìö ${activity.name}: ${baseHours}h ‚Üí ${neededHours.toFixed(2)}h (x${multiplier})`);
            });
            
            console.log(`‚è∞ Total tiempo extra necesario: ${totalExtraNeeded.toFixed(2)}h`);
            
            // PASO 1: Reducir fp-critical (min 1h) y fp-important (min 45min)
            let timeLiberated = 0;
            
            STATE.activeActivities.forEach(actId => {
                const activity = STATE.allActivities[actId];
                if (!activity) return;
                
                // Saltar si tiene entrega urgente
                if (urgentDeliveries.some(d => d.subject === actId)) return;
                
                const sched = activity[schedule];
                if (!sched || sched.hours === 'Var' || sched.hours === '') return;
                
                const currentHours = parseFloat(sched.hours);
                if (isNaN(currentHours)) return;
                
                let minHours = 0;
                if (activity.type === 'fp-critical') minHours = 1;
                else if (activity.type === 'fp-important') minHours = 0.75; // 45min
                
                if (minHours > 0 && currentHours > minHours) {
                    const liberated = currentHours - minHours;
                    timeLiberated += liberated;
                    sched.hours = `${minHours.toFixed(2)}h`;
                    console.log(`‚¨áÔ∏è ${activity.name}: ${currentHours.toFixed(2)}h ‚Üí ${minHours.toFixed(2)}h (libera ${liberated.toFixed(2)}h)`);
                }
            });
            
            console.log(`üì¶ PASO 1 liber√≥: ${timeLiberated.toFixed(2)}h`);
            
            // PASO 2: Eliminar Revisi√≥n
            if (STATE.allActivities.revision) {
                const revSched = STATE.allActivities.revision[schedule];
                if (revSched && revSched.hours) {
                    const hours = parseFloat(revSched.hours);
                    if (!isNaN(hours) && hours > 0) {
                        timeLiberated += hours;
                        revSched.hours = '0h';
                        revSched.start = '';
                        revSched.end = '';
                        console.log(`‚ùå Eliminado: Revisi√≥n (libera ${hours.toFixed(2)}h)`);
                    }
                }
            }
            
            console.log(`üì¶ PASO 2 total liberado: ${timeLiberated.toFixed(2)}h`);
            
            // PASO 3: Si falta tiempo, reducir fp-light (min 45min=0.75h) y learning (min 15min=0.25h)
            if (timeLiberated < totalExtraNeeded) {
                console.log(`‚ö†Ô∏è A√∫n faltan ${(totalExtraNeeded - timeLiberated).toFixed(2)}h - aplicando PASO 3`);
                
                const reducibles = [];
                STATE.activeActivities.forEach(actId => {
                    const activity = STATE.allActivities[actId];
                    if (!activity) return;
                    if (activity.type === 'fp-light' || activity.type === 'learning') {
                        const sched = activity[schedule];
                        if (sched && sched.hours && sched.hours !== 'Var' && sched.hours !== '0h') {
                            const hours = parseFloat(sched.hours);
                            if (!isNaN(hours) && hours > 0) {
                                reducibles.push({ 
                                    id: actId, 
                                    activity: activity, 
                                    hours: hours, 
                                    sched: sched 
                                });
                            }
                        }
                    }
                });
                
                if (reducibles.length > 0) {
                    const dayOfWeek = STATE.currentDate.getDay();
                    const startIndex = dayOfWeek % reducibles.length;
                    
                    for (let i = 0; i < reducibles.length && timeLiberated < totalExtraNeeded; i++) {
                        const idx = (startIndex + i) % reducibles.length;
                        const item = reducibles[idx];
                        
                        const minHours = item.activity.type === 'fp-light' ? 0.75 : 0.25;
                        
                        if (item.hours > minHours) {
                            const reduction = item.hours - minHours;
                            timeLiberated += reduction;
                            item.sched.hours = `${minHours.toFixed(2)}h`;
                            console.log(`‚¨áÔ∏è ${item.activity.name}: ${item.hours.toFixed(2)}h ‚Üí ${minHours.toFixed(2)}h (libera ${reduction.toFixed(2)}h)`);
                        } else if (timeLiberated < totalExtraNeeded) {
                            timeLiberated += item.hours;
                            item.sched.hours = '0h';
                            item.sched.start = '';
                            item.sched.end = '';
                            console.log(`‚ùå Eliminado: ${item.activity.name} (libera ${item.hours.toFixed(2)}h)`);
                        }
                    }
                }
            }
            
            console.log(`‚úÖ Total tiempo liberado: ${timeLiberated.toFixed(2)}h`);
            
            // PASO 4: Aplicar multiplicadores
            boostedActivities.forEach(item => {
                const sched = item.activity[schedule];
                sched.hours = `${item.newHours.toFixed(2)}h`;
                item.activity.boosted = true;
                item.activity.boostedMultiplier = item.multiplier;
                item.activity.boostedBaseHours = item.baseHours;
                console.log(`üî• ${item.activity.name}: ${item.baseHours.toFixed(2)}h ‚Üí ${item.newHours.toFixed(2)}h (x${item.multiplier})`);
            });
            
            // PASO 5: Recalcular horarios start/end
            console.log('üïê Recalculando horarios...');
            
            // Recolectar actividades a programar (excepto fixed)
            const toSchedule = [];
            STATE.activeActivities.forEach(actId => {
                const activity = STATE.allActivities[actId];
                if (!activity) return;
                if (STATE.hasWork && activity.onlyNoWork) return;
                
                const sched = activity[schedule];
                if (!sched || !sched.hours || sched.hours === '0h' || sched.hours === 'Var' || sched.hours === '') return;
                
                const hours = parseFloat(sched.hours);
                if (isNaN(hours) || hours === 0) return;
                
                // Fixed mantienen horario original
                if (activity.fixed || actId === 'cena' || actId === 'familia' || actId === 'nocturna' || actId === 'almuerzo') {
                    const baseSched = BASE_ACTIVITIES[actId][schedule];
                    if (baseSched) {
                        sched.start = baseSched.start;
                        sched.end = baseSched.end;
                        sched.hours = baseSched.hours;
                    }
                    return;
                }
                
                toSchedule.push({
                    id: actId,
                    activity: activity,
                    hours: hours,
                    priority: activity.priority || 3,
                    sched: sched,
                    boosted: activity.boosted || false
                });
            });
            
            // Dividir actividades boosted >3h en 2 bloques
            const finalSchedule = [];
            toSchedule.forEach(item => {
                if (item.boosted && item.hours > 3) {
                    const half = item.hours / 2;
                    finalSchedule.push({
                        ...item,
                        hours: half,
                        priority: item.priority,
                        isPart1: true
                    });
                    finalSchedule.push({
                        ...item,
                        hours: half,
                        priority: item.priority + 0.5,
                        isPart2: true
                    });
                } else {
                    finalSchedule.push(item);
                }
            });
            
            // Ordenar por prioridad
            finalSchedule.sort((a, b) => a.priority - b.priority);
            
            // Programar secuencialmente
            const startTime = 8 * 60; // 08:00 en minutos
            const endTime = 21 * 60; // 21:00 en minutos
            const almuerzoStart = 14 * 60; // 14:00
            const almuerzoEnd = almuerzoStart + (parseFloat(BASE_ACTIVITIES.almuerzo[schedule].hours) * 60);
            
            let currentTime = startTime;
            
            finalSchedule.forEach(item => {
                const durationMinutes = Math.round(item.hours * 60);
                
                // Si choca con almuerzo, saltar despu√©s
                if (currentTime < almuerzoEnd && currentTime + durationMinutes > almuerzoStart) {
                    if (currentTime < almuerzoStart) {
                        currentTime = almuerzoEnd;
                    }
                }
                
                // Verificar que no pase del l√≠mite
                if (currentTime + durationMinutes > endTime) {
                    console.log(`‚ö†Ô∏è ${item.activity.name} no cabe (necesita ${item.hours.toFixed(2)}h)`);
                    item.sched.hours = '0h';
                    item.sched.start = '';
                    item.sched.end = '';
                    return;
                }
                
                // Calcular horarios
                const startH = Math.floor(currentTime / 60);
                const startM = currentTime % 60;
                const endTimeCalc = currentTime + durationMinutes;
                const endH = Math.floor(endTimeCalc / 60);
                const endM = endTimeCalc % 60;
                
                item.sched.start = `${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')}`;
                item.sched.end = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
                
                const partLabel = item.isPart1 ? ' (1/2)' : item.isPart2 ? ' (2/2)' : '';
                console.log(`‚úì ${item.activity.name}${partLabel}: ${item.sched.start}-${item.sched.end} (${item.hours.toFixed(2)}h)`);
                
                // Avanzar SIN huecos
                currentTime = endTimeCalc;
            });
            
            // Programar almuerzo
            if (STATE.allActivities.almuerzo) {
                const almSched = STATE.allActivities.almuerzo[schedule];
                if (almSched) {
                    const almH = Math.floor(almuerzoStart / 60);
                    const almM = almuerzoStart % 60;
                    const almEndH = Math.floor(almuerzoEnd / 60);
                    const almEndM = almuerzoEnd % 60;
                    
                    almSched.start = `${String(almH).padStart(2, '0')}:${String(almM).padStart(2, '0')}`;
                    almSched.end = `${String(almEndH).padStart(2, '0')}:${String(almEndM).padStart(2, '0')}`;
                    
                    console.log(`‚úì Almuerzo: ${almSched.start}-${almSched.end}`);
                }
            }
            
            console.log('‚úÖ Redistribuci√≥n completada');
        }
            
            // Restaurar horarios base y limpiar boosted
            Object.keys(BASE_ACTIVITIES).forEach(key => {
                const baseAct = BASE_ACTIVITIES[key];
                const stateAct = STATE.allActivities[key];
                if (stateAct && baseAct[schedule]) {
                    stateAct[schedule] = { ...baseAct[schedule] };
                    stateAct.boosted = false;
                    stateAct.boostedMultiplier = null;
                    stateAct.boostedBaseHours = null;
                }
            });
            
            // Detectar entregas urgentes
            const urgentDeliveries = STATE.deliveries.filter(d => {
                const daysUntil = getDaysUntilDelivery(d.date);
                return daysUntil >= 0 && daysUntil <= 3;
            });
            
            if (urgentDeliveries.length === 0) {
                console.log('‚úÖ Sin entregas urgentes - horario normal');
                return;
            }
            
            console.log(`üî• ${urgentDeliveries.length} entrega(s) urgente(s) detectada(s)`);
            
            // Calcular tiempo necesario para entregas
            let totalExtraNeeded = 0;
            urgentDeliveries.forEach(delivery => {
                const activity = STATE.allActivities[delivery.subject];
                if (!activity) return;
                const sched = activity[schedule];
                if (!sched || sched.hours === 'Var') return;
                
                const baseHours = parseFloat(sched.hours);
                if (isNaN(baseHours)) return;
                
                const daysUntil = getDaysUntilDelivery(delivery.date);
                const multiplier = daysUntil === 0 ? 3 : daysUntil === 1 ? 2.5 : 2;
                const neededHours = baseHours * multiplier;
                const extraNeeded = neededHours - baseHours;
                totalExtraNeeded += extraNeeded;
                
                console.log(`üìö ${activity.name}: ${baseHours}h ‚Üí ${neededHours}h (x${multiplier}) - necesita +${extraNeeded}h extra`);
            });
            
            console.log(`‚è∞ Total tiempo extra necesario: ${totalExtraNeeded.toFixed(2)}h`);
            
            // PASO 1: Reducir fp-critical a 1h y fp-important a 45min
            let timeLiberated = 0;
            
            STATE.activeActivities.forEach(actId => {
                const activity = STATE.allActivities[actId];
                if (!activity) return;
                
                // Saltar si esta actividad tiene entrega urgente
                if (urgentDeliveries.some(d => d.subject === actId)) return;
                
                const sched = activity[schedule];
                if (!sched || sched.hours === 'Var' || sched.hours === '') return;
                
                const currentHours = parseFloat(sched.hours);
                if (isNaN(currentHours)) return;
                
                const currentMinutes = currentHours * 60;
                let minMinutes = 0;
                
                // fp-critical: m√≠nimo 1h (60min)
                if (activity.type === 'fp-critical') {
                    minMinutes = 60;
                }
                // fp-important: m√≠nimo 45min
                else if (activity.type === 'fp-important') {
                    minMinutes = 45;
                }
                
                if (minMinutes > 0 && currentMinutes > minMinutes) {
                    const liberated = currentMinutes - minMinutes;
                    timeLiberated += liberated;
                    sched.hours = `${(minMinutes / 60).toFixed(2)}h`;
                    console.log(`‚¨áÔ∏è ${activity.name}: ${currentHours.toFixed(2)}h ‚Üí ${(minMinutes/60).toFixed(2)}h (libera ${(liberated/60).toFixed(2)}h)`);
                }
            });
            
            console.log(`üì¶ PASO 1 liber√≥: ${(timeLiberated/60).toFixed(2)}h`);
            
            // PASO 2: Eliminar Descanso y Revisi√≥n
            STATE.activeActivities.forEach(actId => {
                const activity = STATE.allActivities[actId];
                if (!activity) return;
                
                if (actId === 'descanso1' || actId === 'revision') {
                    const sched = activity[schedule];
                    if (sched && sched.hours) {
                        const hours = parseFloat(sched.hours);
                        if (!isNaN(hours) && hours > 0) {
                            timeLiberated += hours * 60;
                            sched.hours = '0h';
                            sched.start = '';
                            sched.end = '';
                            console.log(`‚ùå Eliminado: ${activity.name} (libera ${hours.toFixed(2)}h)`);
                        }
                    }
                }
            });
            
            console.log(`üì¶ PASO 2 total liberado: ${(timeLiberated/60).toFixed(2)}h`);
            
            // PASO 3: Si a√∫n falta tiempo, reducir fp-light (min 45min) y learning (min 15min)
            const stillNeeded = (totalExtraNeeded * 60) - timeLiberated;
            
            if (stillNeeded > 0) {
                console.log(`‚ö†Ô∏è A√∫n faltan ${(stillNeeded/60).toFixed(2)}h - aplicando PASO 3`);
                
                // Crear lista de fp-light y learning para reducir/eliminar
                const reducibles = [];
                STATE.activeActivities.forEach(actId => {
                    const activity = STATE.allActivities[actId];
                    if (!activity) return;
                    if (activity.type === 'fp-light' || activity.type === 'learning') {
                        const sched = activity[schedule];
                        if (sched && sched.hours && sched.hours !== 'Var' && sched.hours !== '0h') {
                            const hours = parseFloat(sched.hours);
                            if (!isNaN(hours) && hours > 0) {
                                reducibles.push({ 
                                    id: actId, 
                                    name: activity.name, 
                                    type: activity.type,
                                    hours: hours, 
                                    schedule: sched 
                                });
                            }
                        }
                    }
                });
                
                if (reducibles.length > 0) {
                    // Rotar eliminaci√≥n (usar fecha como semilla)
                    const dayOfWeek = STATE.currentDate.getDay();
                    const startIndex = dayOfWeek % reducibles.length;
                    
                    let tempLiberated = timeLiberated;
                    for (let i = 0; i < reducibles.length && (totalExtraNeeded * 60) > tempLiberated; i++) {
                        const idx = (startIndex + i) % reducibles.length;
                        const item = reducibles[idx];
                        
                        // Determinar m√≠nimo seg√∫n tipo
                        const minMinutes = item.type === 'fp-light' ? 45 : 15; // fp-light: 45min, learning: 15min
                        const currentMinutes = item.hours * 60;
                        
                        // Primero intentar reducir al m√≠nimo
                        if (currentMinutes > minMinutes) {
                            const reduction = currentMinutes - minMinutes;
                            tempLiberated += reduction;
                            item.schedule.hours = `${(minMinutes / 60).toFixed(2)}h`;
                            console.log(`‚¨áÔ∏è ${item.name}: ${item.hours.toFixed(2)}h ‚Üí ${(minMinutes/60).toFixed(2)}h (libera ${(reduction/60).toFixed(2)}h)`);
                        }
                        // Si ya est√° en m√≠nimo o menos, eliminar (rotando)
                        else if ((totalExtraNeeded * 60) > tempLiberated) {
                            tempLiberated += currentMinutes;
                            item.schedule.hours = '0h';
                            item.schedule.start = '';
                            item.schedule.end = '';
                            console.log(`‚ùå Eliminado: ${item.name} (libera ${item.hours.toFixed(2)}h)`);
                        }
                    }
                    
                    timeLiberated = tempLiberated;
                }
            }
            
            console.log(`‚úÖ Total tiempo liberado: ${(timeLiberated/60).toFixed(2)}h`);
            
            // PASO 4: Aplicar multiplicadores a materias con entrega
            urgentDeliveries.forEach(delivery => {
                const activity = STATE.allActivities[delivery.subject];
                if (!activity) return;
                const sched = activity[schedule];
                if (!sched || sched.hours === 'Var') return;
                
                const baseHours = parseFloat(BASE_ACTIVITIES[delivery.subject][schedule].hours);
                const daysUntil = getDaysUntilDelivery(delivery.date);
                const multiplier = daysUntil === 0 ? 3 : daysUntil === 1 ? 2.5 : 2;
                const newHours = baseHours * multiplier;
                
                sched.hours = `${newHours.toFixed(2)}h`;
                activity.boosted = true;
                activity.boostedMultiplier = multiplier;
                activity.boostedBaseHours = baseHours;
                
                console.log(`üî• ${activity.name}: ${baseHours.toFixed(2)}h ‚Üí ${newHours.toFixed(2)}h (x${multiplier})`);
            });
            
            // PASO 5: Recalcular horarios REALES (08:00-21:00 sin huecos)
            console.log('üïê Recalculando horarios start/end...');
            
            const activitiesToSchedule = [];
            STATE.activeActivities.forEach(actId => {
                const activity = STATE.allActivities[actId];
                if (!activity) return;
                if (STATE.hasWork && activity.onlyNoWork) return;
                
                const sched = activity[schedule];
                if (!sched || !sched.hours || sched.hours === '0h' || sched.hours === 'Var' || sched.hours === '') return;
                
                const hours = parseFloat(sched.hours);
                if (isNaN(hours) || hours === 0) return;
                
                // Bloques intocables mantienen su horario fijo
                if (activity.fixed || actId === 'cena' || actId === 'familia' || actId === 'nocturna') {
                    const baseSched = BASE_ACTIVITIES[actId][schedule];
                    if (baseSched) {
                        sched.start = baseSched.start;
                        sched.end = baseSched.end;
                        sched.hours = baseSched.hours;
                    }
                    return;
                }
                
                // Almuerzo se agrega separadamente con horario movible
                if (actId === 'almuerzo') {
                    return;
                }
                
                activitiesToSchedule.push({
                    id: actId,
                    name: activity.name,
                    hours: hours,
                    priority: activity.priority || 3,
                    schedule: sched,
                    boosted: activity.boosted || false
                });
            });
            
            // Ordenar por prioridad
            activitiesToSchedule.sort((a, b) => a.priority - b.priority);
            
            // Calcular horarios secuencialmente sin huecos
            let currentMinutes = 8 * 60; // 08:00
            const endDay = 21 * 60; // 21:00 l√≠mite
            
            // Ideal almuerzo: 14:00-15:15 (o seg√∫n duraci√≥n base)
            const almuerzoHours = parseFloat(BASE_ACTIVITIES.almuerzo[schedule].hours);
            const almuerzoDuration = almuerzoHours * 60;
            let almuerzoStart = 14 * 60; // Ideal 14:00
            let almuerzoEnd = almuerzoStart + almuerzoDuration;
            
            // Dividir materias boosted muy largas (>3h) en 2 bloques
            const scheduledItems = [];
            activitiesToSchedule.forEach(item => {
                if (item.boosted && item.hours > 3) {
                    // Dividir en 2 bloques (ma√±ana y tarde)
                    const halfHours = item.hours / 2;
                    scheduledItems.push({
                        ...item,
                        hours: halfHours,
                        name: `${item.name} (Parte 1)`,
                        isFirstHalf: true
                    });
                    scheduledItems.push({
                        ...item,
                        hours: halfHours,
                        name: `${item.name} (Parte 2)`,
                        isSecondHalf: true,
                        priority: item.priority + 0.5 // Ligeramente despu√©s
                    });
                } else {
                    scheduledItems.push(item);
                }
            });
            
            // Re-ordenar con bloques divididos
            scheduledItems.sort((a, b) => a.priority - b.priority);
            
            // Asignar horarios sin huecos
            scheduledItems.forEach(item => {
                const durationMinutes = Math.round(item.hours * 60);
                
                // Si choca con almuerzo, saltar al final del almuerzo
                if (currentMinutes < almuerzoEnd && currentMinutes + durationMinutes > almuerzoStart) {
                    // Si empieza antes del almuerzo pero terminar√≠a despu√©s
                    if (currentMinutes < almuerzoStart) {
                        currentMinutes = almuerzoEnd;
                    }
                }
                
                // Si pasa del l√≠mite de d√≠a (21:00), no agregar
                if (currentMinutes + durationMinutes > endDay) {
                    console.log(`‚ö†Ô∏è ${item.name} no cabe en el horario (necesita ${(durationMinutes/60).toFixed(2)}h)`);
                    item.schedule.hours = '0h';
                    item.schedule.start = '';
                    item.schedule.end = '';
                    return;
                }
                
                // Calcular start/end
                const startH = Math.floor(currentMinutes / 60);
                const startM = currentMinutes % 60;
                const endMinutes = currentMinutes + durationMinutes;
                const endH = Math.floor(endMinutes / 60);
                const endM = endMinutes % 60;
                
                item.schedule.start = `${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')}`;
                item.schedule.end = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
                
                console.log(`‚úì ${item.name}: ${item.schedule.start}-${item.schedule.end} (${item.hours.toFixed(2)}h)`);
                
                // Avanzar SIN huecos
                currentMinutes = endMinutes;
            });
            
            console.log('‚úÖ Redistribuci√≥n completada');
        }
        
        function changeDate(days) {
            STATE.currentDate = new Date(STATE.currentDate.getTime() + (days * 86400000));
            render();
        }
        
        function updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleTimeString('es-ES');
            }
        }
        
        // =================================================================
        // SISTEMA DE ALARMAS
        // =================================================================
        
        function initAlarms() {
            // Pedir permisos de notificaci√≥n
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Permisos de notificaci√≥n concedidos');
                        }
                    });
                }, 2000);
            }
            
            // Verificar alarmas cada minuto
            setInterval(checkAlarms, 60000);
        }
        
        function checkAlarms() {
            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const todayKey = getDateKey(now);
            const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
            
            STATE.activeActivities.forEach(activityId => {
                const activity = STATE.allActivities[activityId];
                if (!activity) return;
                
                const sched = activity[schedule];
                if (!sched || sched.start === '' || sched.start === 'Var') return;
                
                const notificationKey = `${todayKey}-${activityId}-${sched.start}`;
                
                if (sched.start === currentTimeStr && !STATE.notifiedActivities.has(notificationKey)) {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('‚è∞ FP DAM - Es la hora!', {
                            body: `Ahora: ${activity.name} (${sched.hours})`,
                            icon: 'üìö',
                            tag: notificationKey
                        });
                    }
                    
                    STATE.notifiedActivities.add(notificationKey);
                }
            });
        }
        
        // =================================================================
        // RENDERIZADO - SETUP VIEW
        // =================================================================
        
        function renderSetup() {
            if (STATE.setupStep === 1) {
                return `
                    <div class="container">
                        <div class="header">
                            <div style="font-size: 60px; margin-bottom: 15px;">üìö</div>
                            <h1>FP DAM Gestor</h1>
                            <p style="margin-top: 10px;">Gesti√≥n de estudio con sincronizaci√≥n autom√°tica</p>
                            <div class="storage-badge">
                                ‚òÅÔ∏è Sincronizado en todos tus dispositivos
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>¬øTienes trabajo actualmente?</h2>
                            <button class="btn btn-success" onclick="selectWorkStatus(false)">
                                üü¢ Sin trabajo
                            </button>
                            <button class="btn btn-primary" onclick="selectWorkStatus(true)">
                                üîµ Con trabajo (8h)
                            </button>
                        </div>
                        
                        <div class="card">
                            <p class="text-gray text-sm text-center">
                                üí° Esta configuraci√≥n determinar√° tu horario de estudio
                            </p>
                        </div>
                    </div>
                `;
            }
            
            if (STATE.setupStep === 2) {
                let activitiesHTML = '';
                Object.values(STATE.allActivities).forEach(activity => {
                    if (STATE.hasWork && activity.onlyNoWork) return;
                    
                    const isActive = STATE.activeActivities.includes(activity.id);
                    activitiesHTML += `
                        <label class="activity-item ${isActive ? 'completed' : ''}" style="cursor: pointer;">
                            <input type="checkbox" 
                                   ${isActive ? 'checked' : ''}
                                   onchange="toggleActivitySelection('${activity.id}')"
                                   style="width: 20px; height: 20px;">
                            <div class="activity-content">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-time">${activity.type}</div>
                            </div>
                        </label>
                    `;
                });
                
                return `
                    <div class="container">
                        <div class="header">
                            <h1>Selecciona Actividades</h1>
                            <p style="margin-top: 10px;">Marca las que quieras incluir en tu agenda</p>
                        </div>
                        
                        <div class="card">
                            <h2>Actividades Disponibles</h2>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-success" style="flex: 1;" onclick="selectAllActivities()">
                                    ‚úÖ Seleccionar Todo
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="selectNoneActivities()">
                                    ‚ùå Ninguna
                                </button>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${activitiesHTML}
                            </div>
                        </div>
                        
                        <div class="card">
                            <button class="btn btn-primary" onclick="finishSetup()">
                                ¬°Empezar! üöÄ
                            </button>
                            <p class="text-gray text-sm text-center mt-2">
                                Seleccionadas: <strong id="selected-count">${STATE.activeActivities.length}</strong>
                            </p>
                        </div>
                    </div>
                `;
            }
        }
        
        // =================================================================
        // RENDERIZADO - HOME VIEW
        // =================================================================
        
        function renderHome() {
            const progress = getProgress();
            const totalCompleted = getTotalCompleted();
            const pendingDeliveries = STATE.deliveries.length;
            
            return `
                <div class="container">
                    <div class="header">
                        <h1>${formatDate(STATE.currentDate)}</h1>
                        <div class="time" id="current-time">${new Date().toLocaleTimeString('es-ES')}</div>
                        <div class="storage-badge">
                            üíæ Guardado autom√°tico activo
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Estad√≠sticas</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${totalCompleted}</div>
                                <div class="stat-label">Tareas Completadas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${pendingDeliveries}</div>
                                <div class="stat-label">Entregas Pendientes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Navegaci√≥n R√°pida</h2>
                        <button class="btn btn-primary" onclick="changeView('daily')">
                            üìÖ Vista Diaria
                        </button>
                        <button class="btn btn-primary" onclick="changeView('weekly')">
                            üìä Vista Semanal
                        </button>
                        <button class="btn btn-primary" onclick="changeView('deliveries')">
                            üìö Gesti√≥n de Entregas
                        </button>
                        <button class="btn btn-primary" onclick="changeView('settings')">
                            ‚öôÔ∏è Configuraci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <p class="text-gray text-sm text-center">
                            Situaci√≥n: ${STATE.hasWork ? 'üîµ Con trabajo (8h)' : 'üü¢ Sin trabajo'}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - DAILY VIEW
        // =================================================================
        
        function renderDaily() {
            const isSunday = STATE.currentDate.getDay() === 0;
            const progress = getProgress();
            const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
            
            let activitiesHTML = '';
            
            if (!isSunday) {
                const dayOfWeek = STATE.currentDate.getDay();
                const sortedActivities = STATE.activeActivities
                    .map(id => STATE.allActivities[id])
                    .filter(a => {
                        if (!a) return false;
                        if (STATE.hasWork && a.onlyNoWork) return false;
                        
                        // Filtrar capacitaciones por d√≠a de la semana
                        if (a.weekDays && !a.weekDays.includes(dayOfWeek)) return false;
                        
                        const sched = a[schedule];
                        return sched && sched.start !== '' && sched.start !== 'Var' && sched.hours !== '0h';
                    })
                    .sort((a, b) => a[schedule].start.localeCompare(b[schedule].start));
                
                sortedActivities.forEach(activity => {
                    const sched = activity[schedule];
                    const completed = isTaskCompleted(activity.id);
                    
                    activitiesHTML += `
                        <div class="activity-item ${completed ? 'completed' : ''}" onclick="toggleTask('${activity.id}')">
                            <div class="checkbox ${completed ? 'checked' : ''}"></div>
                            <div class="activity-content">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-time">‚è∞ ${sched.start} - ${sched.end}</div>
                            </div>
                            <span class="badge ${activity.color}">${sched.hours}</span>
                            ${activity.boosted ? `<span class="badge badge-orange">${activity.boostedBaseHours}h ‚Üí ${parseFloat(sched.hours).toFixed(1)}h üî•</span>` : ''}
                        </div>
                    `;
                });
            }
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Anterior</button>
                        <button class="nav-btn" onclick="changeView('home')">üè† Inicio</button>
                        <button class="nav-btn" onclick="changeDate(1)">Siguiente ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>${formatDate(STATE.currentDate)}</h1>
                        <p style="margin-top: 10px;">Progreso del d√≠a</p>
                    </div>
                    
                    ${!isSunday ? `
                        <div class="card">
                            <h2>Progreso: ${progress}%</h2>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="text-center mb-2" style="background: #fef3c7; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24;">
                                <strong>üîî Sistema de Alarmas Activo</strong><br>
                                <span class="text-sm">Recibir√°s notificaciones al inicio de cada actividad</span>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>üìÖ Agenda del D√≠a</h2>
                            ${activitiesHTML || '<p class="text-gray text-center">No hay actividades programadas</p>'}
                        </div>
                    ` : `
                        <div class="card" style="background: #f0fdf4; border: 3px solid #22c55e; text-align: center; padding: 40px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">üéâ</div>
                            <h2 style="color: #16a34a; font-size: 24px;">D√≠a de Descanso</h2>
                            <p style="color: #15803d; margin-top: 10px;">Domingo OFF - Disfruta tu d√≠a</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - WEEKLY VIEW
        // =================================================================
        
        function renderWeekly() {
            const getWeekDays = () => {
                const days = [];
                const today = new Date();
                const currentDay = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    days.push(day);
                }
                return days;
            };
            
            const weekDays = getWeekDays();
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            let daysHTML = '';
            weekDays.forEach((day, index) => {
                const isSunday = day.getDay() === 0;
                const isToday = getDateKey(day) === getDateKey(new Date());
                const progress = getProgress(day);
                
                daysHTML += `
                    <div class="day-card ${isToday ? 'today' : ''} ${isSunday ? 'sunday' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; font-size: 18px;">${dayNames[day.getDay()]} ${day.getDate()}</div>
                                ${isToday ? '<div style="color: #3b82f6; font-size: 13px; font-weight: 600;">HOY</div>' : ''}
                            </div>
                            ${isSunday ? 
                                '<span class="badge badge-green">OFF üéâ</span>' : 
                                `<div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${progress}%</div>`
                            }
                        </div>
                        ${!isSunday ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Vista Semanal</span>
                        <button class="nav-btn" onclick="changeView('daily')">Diaria ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>Vista Semanal</h1>
                        <p style="margin-top: 10px;">Progreso de la semana</p>
                    </div>
                    
                    <div class="week-days">
                        ${daysHTML}
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - DELIVERIES VIEW
        // =================================================================
        
        function renderDeliveries() {
            const fpSubjects = Object.values(STATE.allActivities).filter(a => a.type.startsWith('fp-'));
            
            let deliveriesHTML = '';
            if (STATE.deliveries.length > 0) {
                STATE.deliveries.forEach(delivery => {
                    const daysUntil = getDaysUntilDelivery(delivery.date);
                    const isUrgent = daysUntil >= 0 && daysUntil <= 3;
                    const activity = STATE.allActivities[delivery.subject];
                    
                    let boostInfo = '';
                    if (isUrgent && activity?.boosted) {
                        const multiplier = activity.boostedMultiplier || 2;
                        const addedHours = (parseFloat(activity[STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork'].hours) - parseFloat(activity.originalHours)).toFixed(1);
                        boostInfo = `
                            <div class="delivery-boost">
                                <strong style="color: #ea580c;">üî• Horario Ajustado Autom√°ticamente</strong><br>
                                <div style="font-size: 13px; color: #9a3412; margin-top: 5px;">
                                    ‚Ä¢ Tiempo original: <strong>${activity.originalHours}</strong><br>
                                    ‚Ä¢ Tiempo ajustado: <strong>${activity[STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork'].hours}</strong> (${multiplier}x)<br>
                                    ‚Ä¢ Tiempo adicional: <strong>+${addedHours}h</strong>
                                </div>
                                <div style="font-size: 12px; color: #9a3412; margin-top: 8px; font-style: italic;">
                                    üí° Se restaurar√° autom√°ticamente cuando pase la fecha
                                </div>
                            </div>
                        `;
                    }
                    
                    const dateStr = delivery.date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    const badgeColor = daysUntil < 0 ? 'badge-secondary' : 
                                      daysUntil === 0 ? 'badge-red' :
                                      daysUntil === 1 ? 'badge-red' :
                                      daysUntil <= 3 ? 'badge-orange' : 'badge-blue';
                    const badgeText = daysUntil < 0 ? '‚ùå Vencida' :
                                     daysUntil === 0 ? 'üî• HOY' :
                                     daysUntil === 1 ? '‚ö° Ma√±ana' :
                                     `‚è∞ ${daysUntil} d√≠as`;
                    
                    deliveriesHTML += `
                        <div class="delivery-item ${isUrgent ? 'urgent' : ''}">
                            <div class="delivery-header">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 17px; margin-bottom: 5px;">${activity?.name}</div>
                                    <div style="color: #6b7280; margin-bottom: 8px;">${delivery.description}</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 13px; color: #6b7280;">üìÖ ${dateStr}</span>
                                        <span class="badge ${badgeColor}">${badgeText}</span>
                                    </div>
                                </div>
                                <button onclick="deleteDelivery(${delivery.id})" 
                                        style="background: none; border: none; font-size: 24px; color: #ef4444; cursor: pointer; padding: 5px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                            ${boostInfo}
                        </div>
                    `;
                });
            } else {
                deliveriesHTML = '<p class="text-gray text-center">No hay entregas programadas</p>';
            }
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Entregas</span>
                        <button class="nav-btn" onclick="changeView('settings')">Ajustes ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>Gesti√≥n de Entregas</h1>
                        <p style="margin-top: 10px;">Redistribuci√≥n autom√°tica de horarios</p>
                    </div>
                    
                    <div class="card">
                        <h2>Nueva Entrega</h2>
                        <form onsubmit="handleAddDelivery(event)">
                            <label>Materia FP</label>
                            <select id="delivery-subject" required>
                                <option value="">Selecciona una materia...</option>
                                ${fpSubjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                            
                            <label>Fecha de Entrega</label>
                            <input type="date" id="delivery-date" required>
                            
                            <label>Descripci√≥n</label>
                            <input type="text" id="delivery-desc" placeholder="Ej: Proyecto final m√≥dulo 2" required>
                            
                            <button type="submit" class="btn btn-primary">+ Agregar Entrega</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h2>Entregas Programadas</h2>
                        ${deliveriesHTML}
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - SETTINGS VIEW
        // =================================================================
        
        function renderSettings() {
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Configuraci√≥n</span>
                        <div></div>
                    </div>
                    
                    <div class="header">
                        <h1>‚öôÔ∏è Configuraci√≥n</h1>
                        <p style="margin-top: 10px;">Gestiona tu app</p>
                    </div>
                    
                    <div class="card">
                        <h2>Situaci√≥n Laboral</h2>
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>${STATE.hasWork ? 'üîµ Con trabajo (8h)' : 'üü¢ Sin trabajo'}</strong>
                        </div>
                        <button class="btn btn-primary" onclick="toggleWorkStatus()">
                            Cambiar Situaci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>üíæ Backup & Restauraci√≥n</h2>
                        <p class="text-gray text-sm mb-2">
                            Guarda y restaura tus datos de forma segura
                        </p>
                        <button class="btn btn-success" onclick="downloadBackup()">
                            ‚¨áÔ∏è Descargar Backup (.json)
                        </button>
                        <button class="btn btn-primary" onclick="uploadToDrive()">
                            ‚òÅÔ∏è Backup a Google Drive
                        </button>
                        
                        <h2 style="margin-top: 20px;">Restaurar Backup</h2>
                        <button class="btn btn-warning" onclick="restoreBackup()">
                            üìÅ Restaurar desde Archivo Local
                        </button>
                        <button class="btn btn-warning" onclick="restoreFromDrive()">
                            ‚òÅÔ∏è Restaurar desde Google Drive
                        </button>
                        
                        <div style="background: #eff6ff; border: 2px solid #3b82f6; padding: 12px; border-radius: 10px; margin-top: 10px;">
                            <strong style="color: #1e40af;">üí° Instrucciones:</strong>
                            <p style="margin: 8px 0; color: #1e3a8a; font-size: 13px;">
                                <strong>Backup a Drive:</strong> Descarga JSON + abre Drive ‚Üí Arrastra archivo
                            </p>
                            <p style="margin: 8px 0; color: #1e3a8a; font-size: 13px;">
                                <strong>Restaurar Local:</strong> Selecciona archivo .json de tu dispositivo
                            </p>
                            <p style="margin: 8px 0; color: #1e3a8a; font-size: 13px;">
                                <strong>Restaurar Drive:</strong> Abre Drive ‚Üí Descarga JSON ‚Üí Usa "Restaurar Local"
                            </p>
                        </div>
                    </div>
                    
                    <div class="card" style="background: #fef2f2; border: 2px solid #ef4444;">
                        <h2 style="color: #dc2626;">‚ö†Ô∏è Zona Peligrosa</h2>
                        <p class="text-gray text-sm mb-2">
                            Esto borrar√° TODOS los datos permanentemente
                        </p>
                        <button class="btn btn-danger" onclick="resetApp()">
                            üîÑ Reiniciar Configuraci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <p class="text-gray text-sm text-center">
                            FP DAM Gestor v3.0 - JavaScript Vanilla<br>
                            Almacenamiento: localStorage permanente<br>
                            <strong>Dispositivo: Samsung A36</strong>
                        </p>
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO PRINCIPAL
        // =================================================================
        
        function render() {
            const app = document.getElementById('app');
            let html = '';
            
            switch(STATE.currentView) {
                case 'setup':
                    html = renderSetup();
                    break;
                case 'home':
                    html = renderHome();
                    break;
                case 'daily':
                    html = renderDaily();
                    break;
                case 'weekly':
                    html = renderWeekly();
                    break;
                case 'deliveries':
                    html = renderDeliveries();
                    break;
                case 'settings':
                    html = renderSettings();
                    break;
                default:
                    html = renderHome();
            }
            
            app.innerHTML = html;
            
            // Actualizar reloj si estamos en home o daily
            if (STATE.currentView === 'home' || STATE.currentView === 'daily') {
                setInterval(updateTime, 1000);
            }
            
            // Aplicar boost de entregas urgentes
            applyUrgentBoost();
        }
        
        // =================================================================
        // EVENT HANDLERS
        // =================================================================
        
        function selectWorkStatus(hasWork) {
            STATE.hasWork = hasWork;
            STATE.setupStep = 2;
            render();
        }
        
        function toggleActivitySelection(activityId) {
            const index = STATE.activeActivities.indexOf(activityId);
            if (index > -1) {
                STATE.activeActivities.splice(index, 1);
            } else {
                STATE.activeActivities.push(activityId);
            }
            // Actualizar solo el contador sin re-renderizar toda la p√°gina
            const counterEl = document.getElementById('selected-count');
            if (counterEl) {
                counterEl.textContent = STATE.activeActivities.length;
            }
        }
        
        function finishSetup() {
            if (STATE.activeActivities.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos 1 actividad');
                return;
            }
            STATE.currentView = 'home';
            saveData();
            render();
        }
        
        function selectAllActivities() {
            STATE.activeActivities = [];
            Object.values(STATE.allActivities).forEach(activity => {
                if (!(STATE.hasWork && activity.onlyNoWork)) {
                    STATE.activeActivities.push(activity.id);
                }
            });
            render();
        }
        
        function selectNoneActivities() {
            STATE.activeActivities = [];
            render();
        }
        
        function changeView(view) {
            STATE.currentView = view;
            render();
        }
        
        function toggleWorkStatus() {
            if (confirm('¬øCambiar situaci√≥n laboral? Esto ajustar√° todos los horarios.')) {
                STATE.hasWork = !STATE.hasWork;
                saveData();
                render();
            }
        }
        
        function handleAddDelivery(event) {
            event.preventDefault();
            const subject = document.getElementById('delivery-subject').value;
            const date = document.getElementById('delivery-date').value;
            const description = document.getElementById('delivery-desc').value;
            addDelivery(subject, date, description);
            document.getElementById('delivery-subject').value = '';
            document.getElementById('delivery-date').value = '';
            document.getElementById('delivery-desc').value = '';
        }
        
        // =================================================================
        // INICIALIZACI√ìN
        // =================================================================
        
        window.addEventListener('load', async () => {
            console.log('üöÄ Iniciando FP DAM Gestor...');
            
            // Cargar datos guardados (async)
            await loadData();
            
            // Ocultar pantalla de carga
            setTimeout(() => {
                document.getElementById('loading').classList.add('hide');
                document.getElementById('app').classList.remove('hide');
                render();
                console.log('‚úÖ App cargada correctamente');
            }, 1000);
            
            // Inicializar sistema de alarmas
            initAlarms();
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('‚úÖ Service Worker registrado'))
                    .catch(err => console.log('‚ö†Ô∏è Service Worker error:', err));
            }
        });
        
        // Guardar antes de cerrar
        window.addEventListener('beforeunload', saveData);
        
        console.log('‚úÖ FP DAM Gestor - Script cargado');
    </script>
</body>
</html>
