<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="./manifest.json">
    <title>FP DAM Gestor - Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; overflow-x: hidden; }
        
        /* Loading Screen */
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2563eb, #9333ea); 
                   display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; }
        .loading.hide { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; 
                   border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Save Indicator */
        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: #22c55e; color: white; 
                         padding: 10px 20px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                         opacity: 0; transition: opacity 0.3s; z-index: 999; }
        .save-indicator.show { opacity: 1; }
        
        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #2563eb, #9333ea); color: white; padding: 25px 20px; 
                 text-align: center; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header h1 { font-size: 26px; margin-bottom: 10px; }
        .header .time { font-size: 28px; font-weight: bold; margin-top: 10px; font-family: monospace; }
        .storage-badge { background: rgba(34, 197, 94, 0.3); border: 2px solid rgba(34, 197, 94, 0.6); 
                        padding: 8px 16px; border-radius: 20px; font-size: 13px; margin-top: 10px; display: inline-block; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { font-size: 20px; margin-bottom: 15px; color: #1f2937; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
               cursor: pointer; margin-bottom: 10px; transition: all 0.3s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #9333ea); color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        
        /* Activity Items */
        .activity-item { padding: 15px; background: #f3f4f6; border-radius: 12px; margin-bottom: 10px; 
                        display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; }
        .activity-item:hover { background: #e5e7eb; }
        .activity-item.completed { background: #d1fae5; border: 2px solid #22c55e; }
        
        .checkbox { width: 30px; height: 30px; min-width: 30px; border: 3px solid #9ca3af; border-radius: 50%;
                   display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .checkbox.checked { background: #22c55e; border-color: #22c55e; }
        .checkbox.checked::after { content: '‚úì'; color: white; font-weight: bold; font-size: 20px; }
        
        .activity-content { flex: 1; }
        .activity-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .activity-time { font-size: 13px; color: #6b7280; }
        
        /* Badges */
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; color: white; }
        .badge-red { background: #ef4444; }
        .badge-yellow { background: #eab308; }
        .badge-green { background: #22c55e; }
        .badge-blue { background: #3b82f6; }
        .badge-purple { background: #a855f7; }
        .badge-orange { background: #f97316; }
        
        /* Progress Bar */
        .progress-bar { width: 100%; height: 12px; background: #e5e7eb; border-radius: 20px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #9333ea); transition: width 0.5s; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-card { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 20px; 
                    border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 13px; opacity: 0.9; }
        
        /* Forms */
        select, input[type="date"], input[type="text"], input[type="time"], textarea {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;
            margin-bottom: 15px; font-family: inherit; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
        
        /* Delivery Items */
        .delivery-item { padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #e5e7eb; }
        .delivery-item.urgent { background: #fef2f2; border-color: #ef4444; }
        .delivery-header { display: flex; justify-content: between; align-items: start; margin-bottom: 10px; }
        .delivery-boost { background: #fff7ed; border: 2px solid #f97316; padding: 12px; border-radius: 10px; margin-top: 10px; }
        
        /* Week View */
        .week-days { display: grid; gap: 12px; }
        .day-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .day-card.today { border: 3px solid #3b82f6; }
        .day-card.sunday { background: #f0fdf4; border: 2px solid #22c55e; }
        
        /* Navigation */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; 
                  background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-btn { background: #f3f4f6; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .nav-btn:hover { background: #e5e7eb; }
        
        /* Utility */
        .hide { display: none !important; }
        .text-center { text-align: center; }
        .text-gray { color: #6b7280; }
        .text-sm { font-size: 14px; }
        .mt-2 { margin-top: 8px; }
        .mb-2 { margin-bottom: 8px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                        display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: white; border-radius: 20px; padding: 25px; max-width: 500px; width: 100%; 
                max-height: 80vh; overflow-y: auto; }
        .modal h3 { font-size: 22px; margin-bottom: 15px; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 28px; cursor: pointer; color: #6b7280; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px;">FP DAM Gestor</h2>
        <p style="margin-top: 10px; opacity: 0.9;">Cargando aplicaci√≥n...</p>
        <p style="margin-top: 5px; font-size: 14px;">üíæ Almacenamiento Permanente</p>
    </div>
    
    <!-- Save Indicator -->
    <div id="save-indicator" class="save-indicator">üíæ Guardado</div>
    
    <!-- App Container -->
    <div id="app" class="hide"></div>
    
    <script>
        console.log('üöÄ FP DAM Gestor - Versi√≥n JavaScript Vanilla Completa');
        console.log('üíæ Almacenamiento: localStorage permanente');
        
        // =================================================================
        // DATOS BASE
        // =================================================================
        
        const BASE_ACTIVITIES = {
            prog: { id: 'prog', name: 'Programaci√≥n', type: 'fp-critical', color: 'badge-red',
                    scheduleNoWork: { start: '08:00', end: '10:00', hours: '2h' },
                    scheduleWithWork: { start: '07:30', end: '08:30', hours: '1h' }, priority: 1 },
            bd: { id: 'bd', name: 'Base de Datos', type: 'fp-critical', color: 'badge-red',
                  scheduleNoWork: { start: '10:15', end: '11:45', hours: '1.5h' },
                  scheduleWithWork: { start: '17:30', end: '18:30', hours: '1h' }, priority: 1 },
            si: { id: 'si', name: 'Sistemas Inform√°ticos', type: 'fp-important', color: 'badge-yellow',
                  scheduleNoWork: { start: '15:00', end: '16:00', hours: '1h' },
                  scheduleWithWork: { start: '18:30', end: '19:00', hours: '0.5h' }, priority: 2 },
            ed: { id: 'ed', name: 'Entornos Desarrollo', type: 'fp-important', color: 'badge-yellow',
                  scheduleNoWork: { start: '16:00', end: '16:45', hours: '0.75h' },
                  scheduleWithWork: { start: '20:30', end: '21:00', hours: '0.5h' }, priority: 2 },
            lm: { id: 'lm', name: 'Lenguajes Marcas', type: 'fp-light', color: 'badge-green',
                  scheduleNoWork: { start: '16:45', end: '17:30', hours: '0.75h' },
                  scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            digi: { id: 'digi', name: 'Digitalizaci√≥n', type: 'fp-light', color: 'badge-green',
                    scheduleNoWork: { start: '17:30', end: '17:50', hours: '0.33h' },
                    scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            ipo: { id: 'ipo', name: 'Itinerario IPO', type: 'fp-light', color: 'badge-green',
                   scheduleNoWork: { start: '17:50', end: '18:05', hours: '0.25h' },
                   scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' }, priority: 3 },
            ingles: { id: 'ingles', name: 'Ingl√©s', type: 'learning', color: 'badge-purple',
                      scheduleNoWork: { start: '07:50', end: '08:00', hours: '0.17h' },
                      scheduleWithWork: { start: '20:30', end: '20:50', hours: '0.33h' }, priority: 2 },
            ias: { id: 'ias', name: 'Estudiar IAs', type: 'learning', color: 'badge-purple',
                   scheduleNoWork: { start: '20:00', end: '20:30', hours: '0.5h' },
                   scheduleWithWork: { start: '19:30', end: '20:00', hours: '0.5h' }, priority: 2 },
            seo: { id: 'seo', name: 'Estudiar SEO', type: 'learning', color: 'badge-purple',
                   scheduleNoWork: { start: '20:30', end: '21:00', hours: '0.5h' },
                   scheduleWithWork: { start: '20:00', end: '20:30', hours: '0.5h' }, priority: 2 },
            trabajo: { id: 'trabajo', name: 'B√∫squeda Trabajo', type: 'personal', color: 'badge-blue',
                       scheduleNoWork: { start: '11:45', end: '13:00', hours: '1.25h' },
                       scheduleWithWork: { start: '', end: '', hours: '' }, priority: 2, onlyNoWork: true },
            tiempolibre: { id: 'tiempolibre', name: 'Tiempo Libre', type: 'personal', color: 'badge-blue',
                           scheduleNoWork: { start: '18:05', end: '19:00', hours: '0.92h' },
                           scheduleWithWork: { start: '', end: '', hours: '' }, priority: 3, onlyNoWork: true },
            cena: { id: 'cena', name: 'Cena', type: 'personal', color: 'badge-orange',
                    scheduleNoWork: { start: '19:00', end: '20:00', hours: '1h' },
                    scheduleWithWork: { start: '22:00', end: '23:00', hours: '1h' }, priority: 3 },
            revision: { id: 'revision', name: 'Revisi√≥n del D√≠a', type: 'personal', color: 'badge-blue',
                        scheduleNoWork: { start: '20:00', end: '20:30', hours: '0.5h' },
                        scheduleWithWork: { start: '', end: '', hours: '' }, priority: 2, onlyNoWork: true },
            familia: { id: 'familia', name: 'Pareja/Familia', type: 'personal', color: 'badge-purple',
                       scheduleNoWork: { start: '21:00', end: '23:00', hours: '2h' },
                       scheduleWithWork: { start: '21:00', end: '23:00', hours: '2h' }, priority: 3 },
            nocturna: { id: 'nocturna', name: 'Rutina Nocturna', type: 'personal', color: 'badge-blue',
                        scheduleNoWork: { start: '23:00', end: '00:00', hours: '1h' },
                        scheduleWithWork: { start: '23:00', end: '00:00', hours: '1h' }, priority: 3 },
            descanso1: { id: 'descanso1', name: 'Descanso', type: 'break', color: 'badge-yellow',
                         scheduleNoWork: { start: '10:00', end: '10:15', hours: '0.25h' },
                         scheduleWithWork: { start: '', end: '', hours: '' }, priority: 3, onlyNoWork: true },
            almuerzo: { id: 'almuerzo', name: 'Almuerzo + Descanso', type: 'break', color: 'badge-orange',
                        scheduleNoWork: { start: '13:00', end: '15:00', hours: '2h' },
                        scheduleWithWork: { start: '13:00', end: '14:00', hours: '1h' }, priority: 3 }
        };
        
        // =================================================================
        // ESTADO GLOBAL
        // =================================================================
        
        let STATE = {
            currentView: 'setup',
            setupStep: 1,
            hasWork: null,
            allActivities: {...BASE_ACTIVITIES},
            activeActivities: [],
            completedTasks: {},
            deliveries: [],
            currentDate: new Date(),
            notifiedActivities: new Set()
        };
        
        // =================================================================
        // ALMACENAMIENTO PERMANENTE
        // =================================================================
        
        function saveData() {
            try {
                const dataToSave = {
                    hasWork: STATE.hasWork,
                    allActivities: STATE.allActivities,
                    activeActivities: STATE.activeActivities,
                    completedTasks: STATE.completedTasks,
                    deliveries: STATE.deliveries,
                    lastSaved: new Date().toISOString(),
                    version: '3.0-vanilla'
                };
                localStorage.setItem('fpDamApp', JSON.stringify(dataToSave));
                showSaveIndicator();
                console.log('üíæ Datos guardados:', new Date().toLocaleTimeString());
                return true;
            } catch (e) {
                console.error('‚ùå Error al guardar:', e);
                alert('Error al guardar datos. Verifica el almacenamiento.');
                return false;
            }
        }
        
        function loadData() {
            try {
                const saved = localStorage.getItem('fpDamApp');
                if (saved) {
                    const data = JSON.parse(saved);
                    STATE.hasWork = data.hasWork;
                    STATE.allActivities = data.allActivities || {...BASE_ACTIVITIES};
                    STATE.activeActivities = data.activeActivities || [];
                    STATE.completedTasks = data.completedTasks || {};
                    STATE.deliveries = (data.deliveries || []).map(d => ({
                        ...d,
                        date: new Date(d.date),
                        created: new Date(d.created || Date.now())
                    }));
                    
                    if (STATE.hasWork !== null) {
                        STATE.currentView = 'home';
                    }
                    console.log('‚úÖ Datos cargados - MODO PERMANENTE');
                    return true;
                }
                console.log('‚ÑπÔ∏è No hay datos guardados');
                return false;
            } catch (e) {
                console.error('‚ùå Error al cargar:', e);
                return false;
            }
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }
        
        function downloadBackup() {
            try {
                const data = {
                    hasWork: STATE.hasWork,
                    allActivities: STATE.allActivities,
                    activeActivities: STATE.activeActivities,
                    completedTasks: STATE.completedTasks,
                    deliveries: STATE.deliveries,
                    exportDate: new Date().toISOString(),
                    version: '3.0-backup'
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fp-dam-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('‚úÖ Backup descargado correctamente\n\nüí° S√∫belo a Google Drive para guardarlo en la nube');
            } catch (e) {
                alert('‚ùå Error al crear backup: ' + e.message);
            }
        }
        
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.hasWork === undefined || !data.allActivities || !data.activeActivities) {
                            throw new Error('Estructura de backup inv√°lida');
                        }
                        
                        STATE.hasWork = data.hasWork;
                        STATE.allActivities = data.allActivities;
                        STATE.activeActivities = data.activeActivities;
                        STATE.completedTasks = data.completedTasks || {};
                        STATE.deliveries = (data.deliveries || []).map(d => ({
                            ...d,
                            date: new Date(d.date),
                            created: new Date(d.created || Date.now())
                        }));
                        
                        saveData();
                        STATE.currentView = 'home';
                        render();
                        alert('‚úÖ Backup restaurado correctamente');
                    } catch (error) {
                        alert('‚ùå Error al restaurar backup:\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function resetApp() {
            if (confirm('‚ö†Ô∏è Esto borrar√° TODOS los datos permanentemente. ¬øEst√°s seguro?')) {
                if (confirm('‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Se perder√°n todas tus configuraciones. ¬øContinuar?')) {
                    localStorage.removeItem('fpDamApp');
                    STATE = {
                        currentView: 'setup',
                        setupStep: 1,
                        hasWork: null,
                        allActivities: {...BASE_ACTIVITIES},
                        activeActivities: [],
                        completedTasks: {},
                        deliveries: [],
                        currentDate: new Date(),
                        notifiedActivities: new Set()
                    };
                    render();
                    alert('‚úÖ Configuraci√≥n reiniciada');
                }
            }
        }
        
        // =================================================================
        // FUNCIONES AUXILIARES
        // =================================================================
        
        function formatDate(date) {
            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${dias[date.getDay()]} ${date.getDate()} de ${meses[date.getMonth()]}`;
        }
        
        function getDateKey(date) {
            return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        }
        
        function toggleTask(activityId) {
            const dateKey = getDateKey(STATE.currentDate);
            if (!STATE.completedTasks[dateKey]) {
                STATE.completedTasks[dateKey] = {};
            }
            STATE.completedTasks[dateKey][activityId] = !STATE.completedTasks[dateKey][activityId];
            saveData();
            render();
        }
        
        function isTaskCompleted(activityId) {
            const dateKey = getDateKey(STATE.currentDate);
            return STATE.completedTasks[dateKey]?.[activityId] || false;
        }
        
        function getProgress(date = STATE.currentDate) {
            const dateKey = getDateKey(date);
            const tasks = STATE.completedTasks[dateKey] || {};
            const completed = Object.values(tasks).filter(Boolean).length;
            const total = STATE.activeActivities.length;
            return total === 0 ? 0 : Math.round((completed / total) * 100);
        }
        
        function getTotalCompleted() {
            let total = 0;
            Object.values(STATE.completedTasks).forEach(dayTasks => {
                total += Object.values(dayTasks).filter(Boolean).length;
            });
            return total;
        }
        
        function getDaysUntilDelivery(deliveryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const delivery = new Date(deliveryDate);
            delivery.setHours(0, 0, 0, 0);
            const diff = delivery - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        function addDelivery(subject, date, description) {
            if (!subject || !date || !description) {
                alert('‚ö†Ô∏è Por favor completa todos los campos');
                return;
            }
            
            const newDelivery = {
                id: Date.now(),
                subject,
                date: new Date(date),
                description,
                created: new Date()
            };
            
            STATE.deliveries.push(newDelivery);
            STATE.deliveries.sort((a, b) => a.date - b.date);
            
            const daysUntil = getDaysUntilDelivery(date);
            if (daysUntil >= 0 && daysUntil <= 3) {
                applyUrgentBoost();
                alert('‚úÖ Entrega agregada!\n\nüî• Como quedan ‚â§3 d√≠as, el horario se ha ajustado autom√°ticamente');
            } else {
                alert('‚úÖ Entrega agregada correctamente');
            }
            
            saveData();
            render();
        }
        
        function deleteDelivery(id) {
            if (confirm('¬øEliminar esta entrega?')) {
                STATE.deliveries = STATE.deliveries.filter(d => d.id !== id);
                applyUrgentBoost();
                saveData();
                render();
            }
        }
        
        function applyUrgentBoost() {
            // Resetear todos los boosts
            Object.keys(STATE.allActivities).forEach(key => {
                if (STATE.allActivities[key].boosted) {
                    const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
                    STATE.allActivities[key][schedule].hours = STATE.allActivities[key].originalHours;
                    delete STATE.allActivities[key].boosted;
                    delete STATE.allActivities[key].originalHours;
                    delete STATE.allActivities[key].boostedMultiplier;
                }
            });
            
            // Aplicar boost a entregas urgentes
            const urgentDeliveries = STATE.deliveries.filter(d => {
                const daysUntil = getDaysUntilDelivery(d.date);
                return daysUntil >= 0 && daysUntil <= 3;
            });
            
            if (urgentDeliveries.length > 0) {
                const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
                
                urgentDeliveries.forEach(delivery => {
                    const activity = STATE.allActivities[delivery.subject];
                    if (activity && activity[schedule] && activity[schedule].hours !== 'Var') {
                        const currentHours = parseFloat(activity[schedule].hours);
                        if (!isNaN(currentHours)) {
                            const daysUntil = getDaysUntilDelivery(delivery.date);
                            let multiplier = 2;
                            
                            if (daysUntil === 0) multiplier = 3;
                            else if (daysUntil === 1) multiplier = 2.5;
                            else if (daysUntil <= 3) multiplier = 2;
                            
                            const boostedHours = currentHours * multiplier;
                            
                            activity.boosted = true;
                            activity.originalHours = activity[schedule].hours;
                            activity.boostedMultiplier = multiplier;
                            activity[schedule].hours = `${boostedHours.toFixed(1)}h`;
                            
                            console.log(`üî• Boost: ${activity.name} ${activity.originalHours} ‚Üí ${activity[schedule].hours}`);
                        }
                    }
                });
            }
        }
        
        function changeDate(days) {
            STATE.currentDate = new Date(STATE.currentDate.getTime() + (days * 86400000));
            render();
        }
        
        function updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleTimeString('es-ES');
            }
        }
        
        // =================================================================
        // SISTEMA DE ALARMAS
        // =================================================================
        
        function initAlarms() {
            // Pedir permisos de notificaci√≥n
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Permisos de notificaci√≥n concedidos');
                        }
                    });
                }, 2000);
            }
            
            // Verificar alarmas cada minuto
            setInterval(checkAlarms, 60000);
        }
        
        function checkAlarms() {
            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const todayKey = getDateKey(now);
            const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
            
            STATE.activeActivities.forEach(activityId => {
                const activity = STATE.allActivities[activityId];
                if (!activity) return;
                
                const sched = activity[schedule];
                if (!sched || sched.start === '' || sched.start === 'Var') return;
                
                const notificationKey = `${todayKey}-${activityId}-${sched.start}`;
                
                if (sched.start === currentTimeStr && !STATE.notifiedActivities.has(notificationKey)) {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('‚è∞ FP DAM - Es la hora!', {
                            body: `Ahora: ${activity.name} (${sched.hours})`,
                            icon: 'üìö',
                            tag: notificationKey
                        });
                    }
                    
                    STATE.notifiedActivities.add(notificationKey);
                }
            });
        }
        
        // =================================================================
        // RENDERIZADO - SETUP VIEW
        // =================================================================
        
        function renderSetup() {
            if (STATE.setupStep === 1) {
                return `
                    <div class="container">
                        <div class="header">
                            <div style="font-size: 60px; margin-bottom: 15px;">üìö</div>
                            <h1>FP DAM Gestor</h1>
                            <p style="margin-top: 10px;">Gesti√≥n de estudio con almacenamiento permanente</p>
                            <div class="storage-badge">
                                üíæ Datos guardados autom√°ticamente
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>¬øTienes trabajo actualmente?</h2>
                            <button class="btn btn-success" onclick="selectWorkStatus(false)">
                                üü¢ Sin trabajo
                            </button>
                            <button class="btn btn-primary" onclick="selectWorkStatus(true)">
                                üîµ Con trabajo (8h)
                            </button>
                        </div>
                        
                        <div class="card">
                            <p class="text-gray text-sm text-center">
                                üí° Esta configuraci√≥n determinar√° tu horario de estudio
                            </p>
                        </div>
                    </div>
                `;
            }
            
            if (STATE.setupStep === 2) {
                let activitiesHTML = '';
                Object.values(STATE.allActivities).forEach(activity => {
                    if (STATE.hasWork && activity.onlyNoWork) return;
                    
                    const isActive = STATE.activeActivities.includes(activity.id);
                    activitiesHTML += `
                        <label class="activity-item ${isActive ? 'completed' : ''}" style="cursor: pointer;">
                            <input type="checkbox" 
                                   ${isActive ? 'checked' : ''}
                                   onchange="toggleActivitySelection('${activity.id}')"
                                   style="width: 20px; height: 20px;">
                            <div class="activity-content">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-time">${activity.type}</div>
                            </div>
                        </label>
                    `;
                });
                
                return `
                    <div class="container">
                        <div class="header">
                            <h1>Selecciona Actividades</h1>
                            <p style="margin-top: 10px;">Marca las que quieras incluir en tu agenda</p>
                        </div>
                        
                        <div class="card">
                            <h2>Actividades Disponibles</h2>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${activitiesHTML}
                            </div>
                        </div>
                        
                        <div class="card">
                            <button class="btn btn-primary" onclick="finishSetup()">
                                ¬°Empezar! üöÄ
                            </button>
                            <p class="text-gray text-sm text-center mt-2">
                                Seleccionadas: ${STATE.activeActivities.length}
                            </p>
                        </div>
                    </div>
                `;
            }
        }
        
        // =================================================================
        // RENDERIZADO - HOME VIEW
        // =================================================================
        
        function renderHome() {
            const progress = getProgress();
            const totalCompleted = getTotalCompleted();
            const pendingDeliveries = STATE.deliveries.length;
            
            return `
                <div class="container">
                    <div class="header">
                        <h1>${formatDate(STATE.currentDate)}</h1>
                        <div class="time" id="current-time">${new Date().toLocaleTimeString('es-ES')}</div>
                        <div class="storage-badge">
                            üíæ Guardado autom√°tico activo
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Estad√≠sticas</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${totalCompleted}</div>
                                <div class="stat-label">Tareas Completadas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${pendingDeliveries}</div>
                                <div class="stat-label">Entregas Pendientes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Navegaci√≥n R√°pida</h2>
                        <button class="btn btn-primary" onclick="changeView('daily')">
                            üìÖ Vista Diaria
                        </button>
                        <button class="btn btn-primary" onclick="changeView('weekly')">
                            üìä Vista Semanal
                        </button>
                        <button class="btn btn-primary" onclick="changeView('deliveries')">
                            üìö Gesti√≥n de Entregas
                        </button>
                        <button class="btn btn-primary" onclick="changeView('settings')">
                            ‚öôÔ∏è Configuraci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <p class="text-gray text-sm text-center">
                            Situaci√≥n: ${STATE.hasWork ? 'üîµ Con trabajo (8h)' : 'üü¢ Sin trabajo'}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - DAILY VIEW
        // =================================================================
        
        function renderDaily() {
            const isSunday = STATE.currentDate.getDay() === 0;
            const progress = getProgress();
            const schedule = STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork';
            
            let activitiesHTML = '';
            
            if (!isSunday) {
                const sortedActivities = STATE.activeActivities
                    .map(id => STATE.allActivities[id])
                    .filter(a => {
                        if (!a) return false;
                        if (STATE.hasWork && a.onlyNoWork) return false;
                        const sched = a[schedule];
                        return sched && sched.start !== '' && sched.start !== 'Var';
                    })
                    .sort((a, b) => a[schedule].start.localeCompare(b[schedule].start));
                
                sortedActivities.forEach(activity => {
                    const sched = activity[schedule];
                    const completed = isTaskCompleted(activity.id);
                    
                    activitiesHTML += `
                        <div class="activity-item ${completed ? 'completed' : ''}" onclick="toggleTask('${activity.id}')">
                            <div class="checkbox ${completed ? 'checked' : ''}"></div>
                            <div class="activity-content">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-time">‚è∞ ${sched.start} - ${sched.end}</div>
                            </div>
                            <span class="badge ${activity.color}">${sched.hours}</span>
                            ${activity.boosted ? `<span class="badge badge-orange">üî• ${activity.boostedMultiplier}x</span>` : ''}
                        </div>
                    `;
                });
            }
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Anterior</button>
                        <button class="nav-btn" onclick="changeView('home')">üè† Inicio</button>
                        <button class="nav-btn" onclick="changeDate(1)">Siguiente ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>${formatDate(STATE.currentDate)}</h1>
                        <p style="margin-top: 10px;">Progreso del d√≠a</p>
                    </div>
                    
                    ${!isSunday ? `
                        <div class="card">
                            <h2>Progreso: ${progress}%</h2>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="text-center mb-2" style="background: #fef3c7; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24;">
                                <strong>üîî Sistema de Alarmas Activo</strong><br>
                                <span class="text-sm">Recibir√°s notificaciones al inicio de cada actividad</span>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>üìÖ Agenda del D√≠a</h2>
                            ${activitiesHTML || '<p class="text-gray text-center">No hay actividades programadas</p>'}
                        </div>
                    ` : `
                        <div class="card" style="background: #f0fdf4; border: 3px solid #22c55e; text-align: center; padding: 40px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">üéâ</div>
                            <h2 style="color: #16a34a; font-size: 24px;">D√≠a de Descanso</h2>
                            <p style="color: #15803d; margin-top: 10px;">Domingo OFF - Disfruta tu d√≠a</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - WEEKLY VIEW
        // =================================================================
        
        function renderWeekly() {
            const getWeekDays = () => {
                const days = [];
                const today = new Date();
                const currentDay = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    days.push(day);
                }
                return days;
            };
            
            const weekDays = getWeekDays();
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            let daysHTML = '';
            weekDays.forEach((day, index) => {
                const isSunday = day.getDay() === 0;
                const isToday = getDateKey(day) === getDateKey(new Date());
                const progress = getProgress(day);
                
                daysHTML += `
                    <div class="day-card ${isToday ? 'today' : ''} ${isSunday ? 'sunday' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; font-size: 18px;">${dayNames[day.getDay()]} ${day.getDate()}</div>
                                ${isToday ? '<div style="color: #3b82f6; font-size: 13px; font-weight: 600;">HOY</div>' : ''}
                            </div>
                            ${isSunday ? 
                                '<span class="badge badge-green">OFF üéâ</span>' : 
                                `<div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${progress}%</div>`
                            }
                        </div>
                        ${!isSunday ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Vista Semanal</span>
                        <button class="nav-btn" onclick="changeView('daily')">Diaria ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>Vista Semanal</h1>
                        <p style="margin-top: 10px;">Progreso de la semana</p>
                    </div>
                    
                    <div class="week-days">
                        ${daysHTML}
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - DELIVERIES VIEW
        // =================================================================
        
        function renderDeliveries() {
            const fpSubjects = Object.values(STATE.allActivities).filter(a => a.type.startsWith('fp-'));
            
            let deliveriesHTML = '';
            if (STATE.deliveries.length > 0) {
                STATE.deliveries.forEach(delivery => {
                    const daysUntil = getDaysUntilDelivery(delivery.date);
                    const isUrgent = daysUntil >= 0 && daysUntil <= 3;
                    const activity = STATE.allActivities[delivery.subject];
                    
                    let boostInfo = '';
                    if (isUrgent && activity?.boosted) {
                        const multiplier = activity.boostedMultiplier || 2;
                        const addedHours = (parseFloat(activity[STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork'].hours) - parseFloat(activity.originalHours)).toFixed(1);
                        boostInfo = `
                            <div class="delivery-boost">
                                <strong style="color: #ea580c;">üî• Horario Ajustado Autom√°ticamente</strong><br>
                                <div style="font-size: 13px; color: #9a3412; margin-top: 5px;">
                                    ‚Ä¢ Tiempo original: <strong>${activity.originalHours}</strong><br>
                                    ‚Ä¢ Tiempo ajustado: <strong>${activity[STATE.hasWork ? 'scheduleWithWork' : 'scheduleNoWork'].hours}</strong> (${multiplier}x)<br>
                                    ‚Ä¢ Tiempo adicional: <strong>+${addedHours}h</strong>
                                </div>
                                <div style="font-size: 12px; color: #9a3412; margin-top: 8px; font-style: italic;">
                                    üí° Se restaurar√° autom√°ticamente cuando pase la fecha
                                </div>
                            </div>
                        `;
                    }
                    
                    const dateStr = delivery.date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    const badgeColor = daysUntil < 0 ? 'badge-secondary' : 
                                      daysUntil === 0 ? 'badge-red' :
                                      daysUntil === 1 ? 'badge-red' :
                                      daysUntil <= 3 ? 'badge-orange' : 'badge-blue';
                    const badgeText = daysUntil < 0 ? '‚ùå Vencida' :
                                     daysUntil === 0 ? 'üî• HOY' :
                                     daysUntil === 1 ? '‚ö° Ma√±ana' :
                                     `‚è∞ ${daysUntil} d√≠as`;
                    
                    deliveriesHTML += `
                        <div class="delivery-item ${isUrgent ? 'urgent' : ''}">
                            <div class="delivery-header">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 17px; margin-bottom: 5px;">${activity?.name}</div>
                                    <div style="color: #6b7280; margin-bottom: 8px;">${delivery.description}</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 13px; color: #6b7280;">üìÖ ${dateStr}</span>
                                        <span class="badge ${badgeColor}">${badgeText}</span>
                                    </div>
                                </div>
                                <button onclick="deleteDelivery(${delivery.id})" 
                                        style="background: none; border: none; font-size: 24px; color: #ef4444; cursor: pointer; padding: 5px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                            ${boostInfo}
                        </div>
                    `;
                });
            } else {
                deliveriesHTML = '<p class="text-gray text-center">No hay entregas programadas</p>';
            }
            
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Entregas</span>
                        <button class="nav-btn" onclick="changeView('settings')">Ajustes ‚Üí</button>
                    </div>
                    
                    <div class="header">
                        <h1>Gesti√≥n de Entregas</h1>
                        <p style="margin-top: 10px;">Redistribuci√≥n autom√°tica de horarios</p>
                    </div>
                    
                    <div class="card">
                        <h2>Nueva Entrega</h2>
                        <form onsubmit="handleAddDelivery(event)">
                            <label>Materia FP</label>
                            <select id="delivery-subject" required>
                                <option value="">Selecciona una materia...</option>
                                ${fpSubjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                            
                            <label>Fecha de Entrega</label>
                            <input type="date" id="delivery-date" required>
                            
                            <label>Descripci√≥n</label>
                            <input type="text" id="delivery-desc" placeholder="Ej: Proyecto final m√≥dulo 2" required>
                            
                            <button type="submit" class="btn btn-primary">+ Agregar Entrega</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h2>Entregas Programadas</h2>
                        ${deliveriesHTML}
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO - SETTINGS VIEW
        // =================================================================
        
        function renderSettings() {
            return `
                <div class="container">
                    <div class="nav-bar">
                        <button class="nav-btn" onclick="changeView('home')">‚Üê Volver</button>
                        <span style="font-weight: bold;">Configuraci√≥n</span>
                        <div></div>
                    </div>
                    
                    <div class="header">
                        <h1>‚öôÔ∏è Configuraci√≥n</h1>
                        <p style="margin-top: 10px;">Gestiona tu app</p>
                    </div>
                    
                    <div class="card">
                        <h2>Situaci√≥n Laboral</h2>
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>${STATE.hasWork ? 'üîµ Con trabajo (8h)' : 'üü¢ Sin trabajo'}</strong>
                        </div>
                        <button class="btn btn-primary" onclick="toggleWorkStatus()">
                            Cambiar Situaci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>üíæ Backup & Restauraci√≥n</h2>
                        <p class="text-gray text-sm mb-2">
                            Guarda y restaura tus datos de forma segura
                        </p>
                        <button class="btn btn-success" onclick="downloadBackup()">
                            ‚¨áÔ∏è Descargar Backup (.json)
                        </button>
                        <button class="btn btn-primary" onclick="restoreBackup()">
                            ‚¨ÜÔ∏è Restaurar desde Backup
                        </button>
                        <div style="background: #eff6ff; border: 2px solid #3b82f6; padding: 12px; border-radius: 10px; margin-top: 10px;">
                            <strong style="color: #1e40af;">üí° Instrucciones para Google Drive:</strong>
                            <ol style="margin: 8px 0 0 20px; color: #1e3a8a; font-size: 13px;">
                                <li>Descarga el backup (.json)</li>
                                <li>Abre Google Drive en tu navegador</li>
                                <li>Sube el archivo a Drive</li>
                                <li>¬°Listo! Tu backup est√° en la nube</li>
                            </ol>
                            <p style="color: #1e3a8a; font-size: 12px; margin-top: 8px;">
                                Para restaurar: Descarga el .json de Drive y usa "Restaurar"
                            </p>
                        </div>
                    </div>
                    
                    <div class="card" style="background: #fef2f2; border: 2px solid #ef4444;">
                        <h2 style="color: #dc2626;">‚ö†Ô∏è Zona Peligrosa</h2>
                        <p class="text-gray text-sm mb-2">
                            Esto borrar√° TODOS los datos permanentemente
                        </p>
                        <button class="btn btn-danger" onclick="resetApp()">
                            üîÑ Reiniciar Configuraci√≥n
                        </button>
                    </div>
                    
                    <div class="card">
                        <p class="text-gray text-sm text-center">
                            FP DAM Gestor v3.0 - JavaScript Vanilla<br>
                            Almacenamiento: localStorage permanente<br>
                            <strong>Dispositivo: Samsung A36</strong>
                        </p>
                    </div>
                </div>
            `;
        }
        
        // =================================================================
        // RENDERIZADO PRINCIPAL
        // =================================================================
        
        function render() {
            const app = document.getElementById('app');
            let html = '';
            
            switch(STATE.currentView) {
                case 'setup':
                    html = renderSetup();
                    break;
                case 'home':
                    html = renderHome();
                    break;
                case 'daily':
                    html = renderDaily();
                    break;
                case 'weekly':
                    html = renderWeekly();
                    break;
                case 'deliveries':
                    html = renderDeliveries();
                    break;
                case 'settings':
                    html = renderSettings();
                    break;
                default:
                    html = renderHome();
            }
            
            app.innerHTML = html;
            
            // Actualizar reloj si estamos en home o daily
            if (STATE.currentView === 'home' || STATE.currentView === 'daily') {
                setInterval(updateTime, 1000);
            }
            
            // Aplicar boost de entregas urgentes
            applyUrgentBoost();
        }
        
        // =================================================================
        // EVENT HANDLERS
        // =================================================================
        
        function selectWorkStatus(hasWork) {
            STATE.hasWork = hasWork;
            STATE.setupStep = 2;
            render();
        }
        
        function toggleActivitySelection(activityId) {
            const index = STATE.activeActivities.indexOf(activityId);
            if (index > -1) {
                STATE.activeActivities.splice(index, 1);
            } else {
                STATE.activeActivities.push(activityId);
            }
            render();
        }
        
        function finishSetup() {
            if (STATE.activeActivities.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos 1 actividad');
                return;
            }
            STATE.currentView = 'home';
            saveData();
            render();
        }
        
        function changeView(view) {
            STATE.currentView = view;
            render();
        }
        
        function toggleWorkStatus() {
            if (confirm('¬øCambiar situaci√≥n laboral? Esto ajustar√° todos los horarios.')) {
                STATE.hasWork = !STATE.hasWork;
                saveData();
                render();
            }
        }
        
        function handleAddDelivery(event) {
            event.preventDefault();
            const subject = document.getElementById('delivery-subject').value;
            const date = document.getElementById('delivery-date').value;
            const description = document.getElementById('delivery-desc').value;
            addDelivery(subject, date, description);
            document.getElementById('delivery-subject').value = '';
            document.getElementById('delivery-date').value = '';
            document.getElementById('delivery-desc').value = '';
        }
        
        // =================================================================
        // INICIALIZACI√ìN
        // =================================================================
        
        window.addEventListener('load', () => {
            console.log('üöÄ Iniciando FP DAM Gestor...');
            
            // Cargar datos guardados
            loadData();
            
            // Ocultar pantalla de carga
            setTimeout(() => {
                document.getElementById('loading').classList.add('hide');
                document.getElementById('app').classList.remove('hide');
                render();
                console.log('‚úÖ App cargada correctamente');
            }, 1000);
            
            // Inicializar sistema de alarmas
            initAlarms();
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('‚úÖ Service Worker registrado'))
                    .catch(err => console.log('‚ö†Ô∏è Service Worker error:', err));
            }
        });
        
        // Guardar antes de cerrar
        window.addEventListener('beforeunload', saveData);
        
        console.log('‚úÖ FP DAM Gestor - Script cargado');
    </script>
</body>
</html>
