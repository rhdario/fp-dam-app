<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FP DAM">
    <meta name="application-name" content="FP DAM Gestor">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Gestor de tiempo y estudio para FP DAM con sistema de alarmas autom√°ticas">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%239333ea;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='40' fill='url(%23grad)'/%3E%3Ctext x='100' y='130' font-size='100' text-anchor='middle' fill='white'%3Eüìö%3C/text%3E%3C/svg%3E">
    
    <title>FP DAM Gestor</title>
    
    <!-- CDN Scripts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            background: #f9fafb;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }
        #install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2563eb, #9333ea);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            max-width: 90%;
            text-align: center;
        }
        #install-banner.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .install-btn {
            background: white;
            color: #2563eb;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin: 8px 4px 0;
            cursor: pointer;
            display: inline-block;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2563eb, #9333ea);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        }
        #loading-screen.hidden {
            display: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .storage-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        .storage-indicator.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Carga -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; font-size: 24px; font-weight: bold;">FP DAM Gestor</h2>
        <p style="margin-top: 10px; opacity: 0.9;">Cargando app...</p>
        <p style="margin-top: 5px; font-size: 14px; opacity: 0.8;">üíæ Almacenamiento Permanente Activado</p>
    </div>
    
    <!-- Indicador de Guardado -->
    <div id="storage-indicator" class="storage-indicator">
        üíæ Guardado
    </div>
    
    <!-- Banner de Instalaci√≥n -->
    <div id="install-banner">
        <div style="font-size: 20px; margin-bottom: 8px;">üìö</div>
        <div style="font-weight: bold; margin-bottom: 4px;">Instalar FP DAM Gestor</div>
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">√ösala como una app nativa</div>
        <button class="install-btn" onclick="installPWA()">Instalar</button>
        <button class="install-btn" onclick="dismissInstallBanner()" style="background: rgba(255,255,255,0.2); color: white;">Ahora no</button>
    </div>
    
    <div id="root"></div>
    
    <script>
        // Variables globales para PWA
        let deferredPrompt;
        
        // Ocultar pantalla de carga cuando termine de cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 1000);
        });
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Error al registrar Service Worker:', error);
                    });
            });
        }
        
        // Detectar evento de instalaci√≥n PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar banner de instalaci√≥n despu√©s de 3 segundos
            setTimeout(() => {
                const banner = document.getElementById('install-banner');
                if (banner && !localStorage.getItem('installBannerDismissed')) {
                    banner.classList.add('show');
                }
            }, 3000);
        });
        
        // Funci√≥n para instalar la PWA
        function installPWA() {
            const banner = document.getElementById('install-banner');
            banner.classList.remove('show');
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Usuario acept√≥ instalar la app');
                    } else {
                        console.log('‚ùå Usuario rechaz√≥ instalar la app');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // Funci√≥n para cerrar el banner
        function dismissInstallBanner() {
            const banner = document.getElementById('install-banner');
            banner.classList.remove('show');
            localStorage.setItem('installBannerDismissed', 'true');
        }
        
        // Detectar cuando la app ya est√° instalada
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA instalada correctamente');
            localStorage.setItem('appInstalled', 'true');
        });
        
        // Solicitar permisos de notificaci√≥n al inicio
        window.addEventListener('load', () => {
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Permisos de notificaci√≥n concedidos');
                        }
                    });
                }, 2000);
            }
        });
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
import React, { useState, useEffect } from 'react';

// ============================================================================
// DATOS BASE
// ============================================================================

const baseActivities = {
  prog: {
    id: 'prog',
    name: 'Programaci√≥n',
    type: 'fp-critical',
    color: 'bg-red-500',
    scheduleNoWork: { start: '08:00', end: '10:00', hours: '2h' },
    scheduleWithWork: { start: '07:30', end: '08:30', hours: '1h' },
    technique: 'practica-primero',
    priority: 1,
    onlyNoWork: false
  },
  bd: {
    id: 'bd',
    name: 'Base de Datos',
    type: 'fp-critical',
    color: 'bg-red-400',
    scheduleNoWork: { start: '10:15', end: '11:45', hours: '1.5h' },
    scheduleWithWork: { start: '17:30', end: '18:30', hours: '1h' },
    technique: 'practica-primero',
    priority: 1,
    onlyNoWork: false
  },
  si: {
    id: 'si',
    name: 'Sistemas Inform√°ticos',
    type: 'fp-important',
    color: 'bg-yellow-500',
    scheduleNoWork: { start: '15:00', end: '16:00', hours: '1h' },
    scheduleWithWork: { start: '18:30', end: '19:00', hours: '0.5h' },
    technique: 'pomodoro',
    priority: 2,
    onlyNoWork: false
  },
  ed: {
    id: 'ed',
    name: 'Entornos Desarrollo',
    type: 'fp-important',
    color: 'bg-yellow-400',
    scheduleNoWork: { start: '16:00', end: '16:45', hours: '0.75h' },
    scheduleWithWork: { start: '20:30', end: '21:00', hours: '0.5h' },
    technique: 'pomodoro',
    priority: 2,
    onlyNoWork: false
  },
  lm: {
    id: 'lm',
    name: 'Lenguajes Marcas',
    type: 'fp-light',
    color: 'bg-green-500',
    scheduleNoWork: { start: '16:45', end: '17:30', hours: '0.75h' },
    scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' },
    technique: 'pomodoro',
    priority: 3,
    onlyNoWork: false
  },
  digi: {
    id: 'digi',
    name: 'Digitalizaci√≥n',
    type: 'fp-light',
    color: 'bg-green-400',
    scheduleNoWork: { start: '17:30', end: '17:50', hours: '0.33h' },
    scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' },
    technique: 'pomodoro',
    priority: 3,
    onlyNoWork: false
  },
  ipo: {
    id: 'ipo',
    name: 'Itinerario IPO',
    type: 'fp-light',
    color: 'bg-green-300',
    scheduleNoWork: { start: '17:50', end: '18:05', hours: '0.25h' },
    scheduleWithWork: { start: 'Var', end: 'Var', hours: 'Var' },
    technique: 'pomodoro',
    priority: 3,
    onlyNoWork: false
  },
  ingles: {
    id: 'ingles',
    name: 'Ingl√©s',
    type: 'learning',
    color: 'bg-purple-500',
    scheduleNoWork: { start: '07:50', end: '08:00', hours: '0.17h' },
    scheduleWithWork: { start: '20:30', end: '20:50', hours: '0.33h' },
    technique: 'consistencia',
    priority: 2,
    onlyNoWork: false
  },
  ias: {
    id: 'ias',
    name: 'Estudiar IAs',
    type: 'learning',
    color: 'bg-purple-600',
    scheduleNoWork: { start: '20:00', end: '20:30', hours: '0.5h' },
    scheduleWithWork: { start: '19:30', end: '20:00', hours: '0.5h' },
    technique: 'practica-primero',
    priority: 2,
    onlyNoWork: false
  },
  seo: {
    id: 'seo',
    name: 'Estudiar SEO',
    type: 'learning',
    color: 'bg-purple-400',
    scheduleNoWork: { start: '20:30', end: '21:00', hours: '0.5h' },
    scheduleWithWork: { start: '20:00', end: '20:30', hours: '0.5h' },
    technique: 'practica-primero',
    priority: 2,
    onlyNoWork: false
  },
  trabajo: {
    id: 'trabajo',
    name: 'B√∫squeda Trabajo',
    type: 'personal',
    color: 'bg-blue-500',
    scheduleNoWork: { start: '11:45', end: '13:00', hours: '1.25h' },
    scheduleWithWork: { start: '', end: '', hours: '' },
    technique: 'organizacion',
    priority: 2,
    onlyNoWork: true
  },
  tiempolibre: {
    id: 'tiempolibre',
    name: 'Tiempo Libre',
    type: 'personal',
    color: 'bg-cyan-400',
    scheduleNoWork: { start: '18:05', end: '19:00', hours: '0.92h' },
    scheduleWithWork: { start: '', end: '', hours: '' },
    technique: 'descanso',
    priority: 3,
    onlyNoWork: true
  },
  cena: {
    id: 'cena',
    name: 'Cena',
    type: 'personal',
    color: 'bg-orange-400',
    scheduleNoWork: { start: '19:00', end: '20:00', hours: '1h' },
    scheduleWithWork: { start: '22:00', end: '23:00', hours: '1h' },
    technique: null,
    priority: 3,
    onlyNoWork: false
  },
  revision: {
    id: 'revision',
    name: 'Revisi√≥n del D√≠a',
    type: 'personal',
    color: 'bg-indigo-500',
    scheduleNoWork: { start: '20:00', end: '20:30', hours: '0.5h' },
    scheduleWithWork: { start: '', end: '', hours: '' },
    technique: 'caja-tiempo',
    priority: 2,
    onlyNoWork: true
  },
  familia: {
    id: 'familia',
    name: 'Pareja/Familia',
    type: 'personal',
    color: 'bg-pink-500',
    scheduleNoWork: { start: '21:00', end: '23:00', hours: '2h' },
    scheduleWithWork: { start: '21:00', end: '23:00', hours: '2h' },
    technique: 'presencia',
    priority: 3,
    onlyNoWork: false
  },
  nocturna: {
    id: 'nocturna',
    name: 'Rutina Nocturna',
    type: 'personal',
    color: 'bg-indigo-700',
    scheduleNoWork: { start: '23:00', end: '00:00', hours: '1h' },
    scheduleWithWork: { start: '23:00', end: '00:00', hours: '1h' },
    technique: 'sueno',
    priority: 3,
    onlyNoWork: false
  },
  descanso1: {
    id: 'descanso1',
    name: 'Descanso',
    type: 'break',
    color: 'bg-amber-400',
    scheduleNoWork: { start: '10:00', end: '10:15', hours: '0.25h' },
    scheduleWithWork: { start: '', end: '', hours: '' },
    technique: 'descanso',
    priority: 3,
    onlyNoWork: true
  },
  almuerzo: {
    id: 'almuerzo',
    name: 'Almuerzo + Descanso',
    type: 'break',
    color: 'bg-orange-500',
    scheduleNoWork: { start: '13:00', end: '15:00', hours: '2h' },
    scheduleWithWork: { start: '13:00', end: '14:00', hours: '1h' },
    technique: 'descanso',
    priority: 3,
    onlyNoWork: false
  }
};

const techniques = {
  'caja-tiempo': {
    title: 'üì¶ Caja de Tiempo Cerrada',
    content: 'Establece bloques de tiempo espec√≠ficos para cada tarea. Una vez que empieza el bloque, trabaja solo en esa actividad hasta que termine el tiempo. No mezcles tareas ni interrumpas con otras actividades.'
  },
  'practica-primero': {
    title: 'üíª Pr√°ctica Primero, Teor√≠a Despu√©s',
    content: 'Empieza haciendo ejercicios pr√°cticos antes de estudiar la teor√≠a. Despu√©s de practicar, revisa los conceptos te√≥ricos para consolidar lo aprendido. Esta t√©cnica es especialmente efectiva para programaci√≥n y bases de datos.'
  },
  'pomodoro': {
    title: '‚è±Ô∏è Pomodoro Adaptado',
    content: 'Trabaja en bloques de 25 minutos con 5 minutos de descanso. Despu√©s de 4 bloques, toma un descanso m√°s largo de 15-30 minutos. Usa un temporizador para mantener el ritmo.'
  },
  'consistencia': {
    title: 'üéØ Consistencia Diaria',
    content: 'Dedica un tiempo corto pero constante cada d√≠a a esta actividad. La clave es la repetici√≥n diaria, no la cantidad de tiempo. Mejor 10 minutos cada d√≠a que 1 hora una vez a la semana.'
  },
  'organizacion': {
    title: 'üìã Organizaci√≥n Efectiva',
    content: 'Planifica tus tareas al inicio del bloque. Prioriza lo m√°s importante. Usa listas de verificaci√≥n. Revisa tu progreso al final del bloque.'
  },
  'descanso': {
    title: 'üåø Descanso Activo',
    content: 'Usa este tiempo para desconectar completamente del estudio. Lev√°ntate, estira, camina, toma agua. Evita pantallas durante los descansos cortos.'
  },
  'sueno': {
    title: 'üò¥ Rutina de Sue√±o',
    content: 'Prep√°rate para dormir: apaga pantallas, reduce luces, haz actividades relajantes. Mant√©n un horario consistente de sue√±o para optimizar el aprendizaje.'
  },
  'presencia': {
    title: 'üíö Presencia Total',
    content: 'Durante este tiempo, desconecta del estudio completamente. Enf√≥cate en estar presente con tus seres queridos. Guarda el tel√©fono y dedica tu atenci√≥n plena.'
  }
};

// ============================================================================
// COMPONENTE PRINCIPAL
// ============================================================================

export default function FPDAMGestor() {
  // Estados principales
  const [currentView, setCurrentView] = useState('setup');
  const [setupStep, setSetupStep] = useState(1);
  const [hasWork, setHasWork] = useState(null);
  const [allActivities, setAllActivities] = useState({...baseActivities});
  const [activeActivities, setActiveActivities] = useState([]);
  const [completedTasks, setCompletedTasks] = useState({});
  const [deliveries, setDeliveries] = useState([]);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [currentTime, setCurrentTime] = useState(new Date());
  const [notifiedActivities, setNotifiedActivities] = useState(new Set());
  const [techniqueModal, setTechniqueModal] = useState(null);
  const [addItemModal, setAddItemModal] = useState(false);
  const [menuOpen, setMenuOpen] = useState(false);
  const [cloudService, setCloudService] = useState(null); // 'google', 'microsoft', 'terabox', null
  const [cloudConnected, setCloudConnected] = useState(false);

  // ============================================================================
  // FUNCIONES AUXILIARES
  // ============================================================================

  const formatDate = (date) => {
    const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    return `${dias[date.getDay()]} ${date.getDate()} de ${meses[date.getMonth()]}`;
  };

  const getDateKey = (date) => {
    return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
  };

  const toggleTask = (activityId) => {
    const dateKey = getDateKey(currentDate);
    setCompletedTasks(prev => ({
      ...prev,
      [dateKey]: {
        ...(prev[dateKey] || {}),
        [activityId]: !(prev[dateKey]?.[activityId] || false)
      }
    }));
  };

  const isTaskCompleted = (activityId, date = currentDate) => {
    const dateKey = getDateKey(date);
    return completedTasks[dateKey]?.[activityId] || false;
  };

  const getProgress = (date) => {
    const dateKey = getDateKey(date);
    const tasks = completedTasks[dateKey] || {};
    const completed = Object.values(tasks).filter(Boolean).length;
    const total = activeActivities.length;
    return total === 0 ? 0 : Math.round((completed / total) * 100);
  };

  const getDaysUntilDelivery = (deliveryDate) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const delivery = new Date(deliveryDate);
    delivery.setHours(0, 0, 0, 0);
    const diff = delivery - today;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  const addDelivery = (subject, date, description) => {
    if (!subject || !date || !description) {
      alert('‚ö†Ô∏è Por favor completa todos los campos');
      return;
    }
    const newDelivery = {
      id: Date.now(),
      subject,
      date: new Date(date),
      description,
      created: new Date()
    };
    setDeliveries(prev => [...prev, newDelivery].sort((a, b) => a.date - b.date));
    
    const daysUntil = getDaysUntilDelivery(date);
    if (daysUntil >= 0 && daysUntil <= 3) {
      alert('‚úÖ Entrega agregada! Como quedan ‚â§3 d√≠as, el horario se ajustar√° autom√°ticamente');
    } else {
      alert('‚úÖ Entrega agregada correctamente');
    }
  };

  const deleteDelivery = (id) => {
    if (confirm('¬øEliminar esta entrega?')) {
      setDeliveries(prev => prev.filter(d => d.id !== id));
    }
  };

  const downloadBackup = () => {
    const data = {
      hasWork,
      allActivities,
      activeActivities,
      completedTasks,
      deliveries,
      exportDate: new Date().toISOString(),
      version: '1.0'
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fp-dam-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Backup descargado correctamente');
  };

  const restoreBackup = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Validar estructura b√°sica
        if (!data.hasWork === undefined || !data.allActivities || !data.activeActivities) {
          throw new Error('Estructura de backup inv√°lida');
        }
        
        setHasWork(data.hasWork);
        setAllActivities(data.allActivities);
        setActiveActivities(data.activeActivities);
        setCompletedTasks(data.completedTasks || {});
        setDeliveries((data.deliveries || []).map(d => ({
          ...d,
          date: new Date(d.date),
          created: new Date(d.created)
        })));
        setCurrentView('home');
        alert('‚úÖ Backup restaurado correctamente');
        
        // Limpiar el input
        event.target.value = '';
      } catch (error) {
        console.error('Error al restaurar:', error);
        alert('‚ùå Error al restaurar backup. Archivo inv√°lido o corrupto.');
        event.target.value = '';
      }
    };
    reader.onerror = () => {
      alert('‚ùå Error al leer el archivo');
      event.target.value = '';
    };
    reader.readAsText(file);
  };

  const connectCloudService = (service) => {
    // Simulaci√≥n de conexi√≥n - en producci√≥n aqu√≠ ir√≠an las APIs reales
    setCloudService(service);
    setCloudConnected(true);
    
    const serviceNames = {
      google: 'Google Drive',
      microsoft: 'OneDrive',
      terabox: 'TeraBox'
    };
    
    alert(`üîó Conectado a ${serviceNames[service]}!\n\nPr√≥ximamente: Sincronizaci√≥n autom√°tica de backups.`);
  };

  const disconnectCloudService = () => {
    if (confirm('¬øDesconectar del servicio en la nube?')) {
      setCloudService(null);
      setCloudConnected(false);
      alert('‚úÖ Desconectado correctamente');
    }
  };

  const resetApp = () => {
    if (confirm('‚ö†Ô∏è Esto borrar√° TODOS los datos permanentemente. ¬øEst√°s seguro?')) {
      if (confirm('‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Se perder√°n todas tus configuraciones, tareas y entregas. ¬øContinuar?')) {
        localStorage.removeItem('fpDamApp');
        sessionStorage.removeItem('fpDamApp'); // Por si acaso
        setCurrentView('setup');
        setSetupStep(1);
        setHasWork(null);
        setAllActivities({...baseActivities});
        setActiveActivities([]);
        setCompletedTasks({});
        setDeliveries([]);
        setNotifiedActivities(new Set());
        setCloudService(null);
        setCloudConnected(false);
        alert('‚úÖ Configuraci√≥n reiniciada completamente');
      }
    }
  };

  const addCustomActivity = (activity) => {
    const customId = `custom_${Date.now()}`;
    const newActivity = {
      ...activity,
      id: customId
    };
    setAllActivities(prev => ({...prev, [customId]: newActivity}));
    setActiveActivities(prev => [...prev, customId]);
    setAddItemModal(false);
    alert('‚úÖ √çtem agregado');
  };

  // ============================================================================
  // EFECTOS
  // ============================================================================

  // Reloj tiempo real
  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  // Pedir permisos notificaci√≥n
  useEffect(() => {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }, []);

  // Sistema de alarmas
  useEffect(() => {
    const now = new Date();
    const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    const todayKey = getDateKey(now);
    const schedule = hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork';
    
    activeActivities.forEach(activityId => {
      const activity = allActivities[activityId];
      if (!activity) return;
      
      const sched = activity[schedule];
      if (!sched || sched.start === '' || sched.start === 'Var') return;
      
      const notificationKey = `${todayKey}-${activityId}-${sched.start}`;
      
      if (sched.start === currentTimeStr && !notifiedActivities.has(notificationKey)) {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('‚è∞ FP DAM - Es la hora!', {
            body: `Ahora: ${activity.name} (${sched.hours})`,
            icon: 'üìö',
            tag: notificationKey
          });
        }
        
        setNotifiedActivities(prev => new Set([...prev, notificationKey]));
      }
    });
  }, [currentTime, allActivities, activeActivities, hasWork, notifiedActivities]);

  // Ajuste autom√°tico entregas urgentes con redistribuci√≥n inteligente
  useEffect(() => {
    if (deliveries.length === 0) return;
    
    // Resetear todos los boosts primero
    const resetActivities = {...allActivities};
    Object.keys(resetActivities).forEach(key => {
      if (resetActivities[key].boosted) {
        const schedule = hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork';
        resetActivities[key][schedule].hours = resetActivities[key].originalHours;
        delete resetActivities[key].boosted;
        delete resetActivities[key].originalHours;
      }
    });
    
    // Identificar entregas urgentes
    const urgentDeliveries = deliveries.filter(d => {
      const daysUntil = getDaysUntilDelivery(d.date);
      return daysUntil >= 0 && daysUntil <= 3;
    });
    
    if (urgentDeliveries.length > 0) {
      const updatedActivities = {...resetActivities};
      const schedule = hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork';
      
      urgentDeliveries.forEach(delivery => {
        const activity = updatedActivities[delivery.subject];
        if (activity && activity[schedule] && activity[schedule].hours !== 'Var') {
          const currentHours = parseFloat(activity[schedule].hours);
          if (!isNaN(currentHours)) {
            // Calcular multiplicador seg√∫n d√≠as restantes
            const daysUntil = getDaysUntilDelivery(delivery.date);
            let multiplier = 2; // Por defecto duplicar
            
            if (daysUntil === 0) multiplier = 3; // Triplicar si es hoy
            else if (daysUntil === 1) multiplier = 2.5; // 2.5x si es ma√±ana
            else if (daysUntil <= 3) multiplier = 2; // 2x si quedan 2-3 d√≠as
            
            const boostedHours = currentHours * multiplier;
            
            activity.boosted = true;
            activity.originalHours = activity[schedule].hours;
            activity.boostedMultiplier = multiplier;
            activity.deliveryDate = delivery.date;
            activity[schedule].hours = `${boostedHours.toFixed(1)}h`;
            
            console.log(`üìö ${activity.name}: ${activity.originalHours} ‚Üí ${activity[schedule].hours} (${multiplier}x)`);
          }
        }
      });
      
      setAllActivities(updatedActivities);
    } else {
      // Si no hay entregas urgentes, asegurarse de que todo est√© reseteado
      setAllActivities(resetActivities);
    }
  }, [deliveries, hasWork]);

  // Persistencia PERMANENTE con localStorage
  useEffect(() => {
    const loadSavedData = () => {
      console.log('üîÑ Cargando datos guardados...');
      const saved = localStorage.getItem('fpDamApp');
      
      if (saved) {
        try {
          const data = JSON.parse(saved);
          console.log('‚úÖ Datos encontrados, restaurando...');
          
          if (data.hasWork !== null && data.hasWork !== undefined) {
            setCurrentView('home');
            setSetupStep(1);
          }
          
          setHasWork(data.hasWork);
          setAllActivities(data.allActivities || {...baseActivities});
          setActiveActivities(data.activeActivities || []);
          setCompletedTasks(data.completedTasks || {});
          setDeliveries((data.deliveries || []).map(d => ({
            ...d,
            date: new Date(d.date),
            created: new Date(d.created)
          })));
          setCloudService(data.cloudService || null);
          setCloudConnected(data.cloudConnected || false);
          
          console.log('‚úÖ Datos cargados correctamente - MODO PERMANENTE');
        } catch (e) {
          console.error('‚ùå Error al cargar datos:', e);
        }
      } else {
        console.log('‚ÑπÔ∏è No hay datos guardados, primera vez');
      }
    };

    loadSavedData();
  }, []);

  // Auto-guardado PERMANENTE con localStorage
  useEffect(() => {
    if (hasWork !== null && Object.keys(allActivities).length > 0) {
      const dataToSave = {
        hasWork,
        allActivities,
        activeActivities,
        completedTasks,
        deliveries,
        cloudService,
        cloudConnected,
        lastSaved: new Date().toISOString(),
        version: '2.0-permanent'
      };
      
      try {
        localStorage.setItem('fpDamApp', JSON.stringify(dataToSave));
        console.log('üíæ Auto-guardado permanente:', new Date().toLocaleTimeString());
        
        // Mostrar indicador visual
        const indicator = document.getElementById('storage-indicator');
        if (indicator) {
          indicator.classList.add('show');
          setTimeout(() => indicator.classList.remove('show'), 1500);
        }
      } catch (error) {
        console.error('‚ùå Error al guardar:', error);
        alert('‚ö†Ô∏è Error al guardar datos. Verifica el espacio de almacenamiento.');
      }
    }
  }, [hasWork, allActivities, activeActivities, completedTasks, deliveries, cloudService, cloudConnected]);

  // ============================================================================
  // COMPONENTES
  // ============================================================================

  const TopBar = () => (
    <div className="sticky top-0 z-40 bg-white border-b-2 border-gray-200 px-4 py-4 flex items-center justify-between shadow-sm">
      <button onClick={() => setMenuOpen(true)} className="text-2xl">‚ò∞</button>
      <div className="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
        FP DAM Gestor
      </div>
      <button onClick={() => setCurrentView('settings')} className="text-2xl">‚öôÔ∏è</button>
    </div>
  );

  const SideMenu = () => (
    <>
      {menuOpen && (
        <div className="fixed inset-0 z-50 flex">
          <div className="bg-white w-72 shadow-2xl overflow-y-auto">
            <div className="bg-gradient-to-br from-blue-600 to-purple-600 text-white p-6">
              <h2 className="text-2xl font-bold">Men√∫</h2>
              <div className="text-sm mt-2 opacity-90 bg-white bg-opacity-20 rounded-lg p-2">
                üíæ Guardado autom√°tico permanente activo
              </div>
            </div>
            <div className="p-4 space-y-2">
              {[
                { icon: 'üè†', text: 'Inicio', view: 'home' },
                { icon: 'üìÖ', text: 'Vista Diaria', view: 'daily' },
                { icon: 'üìä', text: 'Vista Semanal', view: 'weekly' },
                { icon: 'üìö', text: 'Entregas', view: 'deliveries' },
                { icon: 'üìà', text: 'Estad√≠sticas', view: 'stats' },
                { icon: '‚öôÔ∏è', text: 'Configuraci√≥n', view: 'settings' }
              ].map(item => (
                <button
                  key={item.view}
                  onClick={() => { setCurrentView(item.view); setMenuOpen(false); }}
                  className="w-full text-left p-4 rounded-xl hover:bg-blue-50 transition-all flex items-center gap-3 text-lg"
                >
                  <span className="text-2xl">{item.icon}</span>
                  <span>{item.text}</span>
                </button>
              ))}
            </div>
          </div>
          <div className="flex-1 bg-black bg-opacity-50" onClick={() => setMenuOpen(false)} />
        </div>
      )}
    </>
  );

  const TechniqueModal = () => (
    <>
      {techniqueModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" onClick={() => setTechniqueModal(null)}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{techniques[techniqueModal].title}</h3>
            <p className="text-gray-700 leading-relaxed mb-6">{techniques[techniqueModal].content}</p>
            <button
              onClick={() => setTechniqueModal(null)}
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
            >
              Entendido
            </button>
          </div>
        </div>
      )}
    </>
  );

  const AddItemModal = () => {
    const [newItem, setNewItem] = useState({
      name: '',
      type: 'personal',
      color: 'bg-blue-500',
      scheduleNoWork: { start: '', end: '', hours: '' },
      scheduleWithWork: { start: '', end: '', hours: '' },
      technique: null,
      priority: 2,
      onlyNoWork: false
    });

    const colors = ['bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-orange-500', 'bg-indigo-500'];

    const handleSubmit = () => {
      if (!newItem.name || !newItem.scheduleNoWork.start) {
        alert('‚ö†Ô∏è Completa al menos el nombre y hora de inicio');
        return;
      }
      addCustomActivity(newItem);
    };

    return (
      <>
        {addItemModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 overflow-y-auto">
            <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 my-8">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold">Agregar √çtem Personalizado</h3>
                <button onClick={() => setAddItemModal(false)} className="text-3xl hover:text-red-500">√ó</button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block font-semibold mb-2">Nombre</label>
                  <input
                    type="text"
                    value={newItem.name}
                    onChange={e => setNewItem({...newItem, name: e.target.value})}
                    className="w-full p-3 border-2 rounded-xl"
                    placeholder="Ej: Proyecto Personal"
                  />
                </div>

                <div>
                  <label className="block font-semibold mb-2">Tipo</label>
                  <select
                    value={newItem.type}
                    onChange={e => setNewItem({...newItem, type: e.target.value})}
                    className="w-full p-3 border-2 rounded-xl"
                  >
                    <option value="personal">Personal</option>
                    <option value="learning">Aprendizaje</option>
                    <option value="fp-critical">FP Cr√≠tico</option>
                    <option value="fp-important">FP Importante</option>
                    <option value="fp-light">FP Ligero</option>
                    <option value="break">Descanso</option>
                  </select>
                </div>

                <div>
                  <label className="block font-semibold mb-2">Color</label>
                  <div className="grid grid-cols-4 gap-3">
                    {colors.map(color => (
                      <button
                        key={color}
                        onClick={() => setNewItem({...newItem, color})}
                        className={`h-12 rounded-xl ${color} ${newItem.color === color ? 'ring-4 ring-blue-500' : ''}`}
                      />
                    ))}
                  </div>
                </div>

                <div className="border-t-2 pt-4">
                  <h4 className="font-bold mb-3">Horario Sin Trabajo</h4>
                  <div className="grid grid-cols-3 gap-3">
                    <div>
                      <label className="block text-sm mb-1">Inicio</label>
                      <input
                        type="time"
                        value={newItem.scheduleNoWork.start}
                        onChange={e => setNewItem({...newItem, scheduleNoWork: {...newItem.scheduleNoWork, start: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm mb-1">Fin</label>
                      <input
                        type="time"
                        value={newItem.scheduleNoWork.end}
                        onChange={e => setNewItem({...newItem, scheduleNoWork: {...newItem.scheduleNoWork, end: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm mb-1">Duraci√≥n</label>
                      <input
                        type="text"
                        value={newItem.scheduleNoWork.hours}
                        onChange={e => setNewItem({...newItem, scheduleNoWork: {...newItem.scheduleNoWork, hours: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                        placeholder="1h"
                      />
                    </div>
                  </div>
                </div>

                <div className="border-t-2 pt-4">
                  <h4 className="font-bold mb-3">Horario Con Trabajo</h4>
                  <div className="grid grid-cols-3 gap-3">
                    <div>
                      <label className="block text-sm mb-1">Inicio</label>
                      <input
                        type="time"
                        value={newItem.scheduleWithWork.start}
                        onChange={e => setNewItem({...newItem, scheduleWithWork: {...newItem.scheduleWithWork, start: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm mb-1">Fin</label>
                      <input
                        type="time"
                        value={newItem.scheduleWithWork.end}
                        onChange={e => setNewItem({...newItem, scheduleWithWork: {...newItem.scheduleWithWork, end: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm mb-1">Duraci√≥n</label>
                      <input
                        type="text"
                        value={newItem.scheduleWithWork.hours}
                        onChange={e => setNewItem({...newItem, scheduleWithWork: {...newItem.scheduleWithWork, hours: e.target.value}})}
                        className="w-full p-2 border-2 rounded-lg"
                        placeholder="1h"
                      />
                    </div>
                  </div>
                </div>

                <button
                  onClick={handleSubmit}
                  className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all"
                >
                  Agregar √çtem
                </button>
              </div>
            </div>
          </div>
        )}
      </>
    );
  };

  // ============================================================================
  // VISTAS
  // ============================================================================

  const SetupView = () => {
    if (setupStep === 1) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <div className="text-6xl mb-4">üìö</div>
              <h1 className="text-3xl font-bold mb-2">FP DAM Gestor</h1>
              <p className="text-gray-600 mb-4">Primero, cu√©ntanos tu situaci√≥n actual</p>
              <div className="p-4 bg-green-50 border-2 border-green-500 rounded-xl">
                <div className="text-sm font-bold text-green-700 mb-1">
                  üíæ Almacenamiento Permanente
                </div>
                <div className="text-xs text-green-600">
                  Tus datos se guardar√°n autom√°ticamente y permanecer√°n incluso despu√©s de cerrar la app
                </div>
              </div>
            </div>

            <div className="space-y-4">
              <button
                onClick={() => { setHasWork(false); setSetupStep(2); }}
                className="w-full bg-green-500 hover:bg-green-600 text-white py-6 rounded-2xl font-bold text-xl shadow-lg transition-all"
              >
                üü¢ Sin trabajo
              </button>
              <button
                onClick={() => { setHasWork(true); setSetupStep(2); }}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white py-6 rounded-2xl font-bold text-xl shadow-lg transition-all"
              >
                üîµ Con trabajo (8h)
              </button>
            </div>
          </div>
        </div>
      );
    }

    if (setupStep === 2) {
      const toggleActivity = (activityId) => {
        setActiveActivities(prev =>
          prev.includes(activityId)
            ? prev.filter(id => id !== activityId)
            : [...prev, activityId]
        );
      };

      const getTypeBadge = (type) => {
        const badges = {
          'fp-critical': 'FP Cr√≠tico',
          'fp-important': 'FP Importante',
          'fp-light': 'FP Ligero',
          'learning': 'Aprendizaje',
          'personal': 'Personal',
          'break': 'Descanso'
        };
        return badges[type] || type;
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-3xl shadow-xl p-6 mb-6">
              <h2 className="text-2xl font-bold mb-2">Selecciona las actividades</h2>
              <p className="text-gray-600">Marca las que quieras activar en tu agenda</p>
            </div>

            <div className="bg-white rounded-3xl shadow-xl p-6 mb-6 max-h-[60vh] overflow-y-auto">
              <div className="space-y-3">
                {Object.values(allActivities).map(activity => {
                  if (hasWork && activity.onlyNoWork) return null;
                  
                  return (
                    <label
                      key={activity.id}
                      className="flex items-center gap-4 p-4 rounded-xl hover:bg-gray-50 cursor-pointer transition-all border-2 border-gray-100"
                    >
                      <input
                        type="checkbox"
                        checked={activeActivities.includes(activity.id)}
                        onChange={() => toggleActivity(activity.id)}
                        className="w-6 h-6"
                      />
                      <div className={`w-4 h-4 rounded-full ${activity.color}`} />
                      <div className="flex-1">
                        <div className="font-semibold">{activity.name}</div>
                        <div className="text-sm text-gray-500">{getTypeBadge(activity.type)}</div>
                      </div>
                    </label>
                  );
                })}
              </div>
            </div>

            <button
              onClick={() => setAddItemModal(true)}
              className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-4 rounded-2xl font-semibold mb-4 transition-all"
            >
              + Agregar √çtem Personalizado
            </button>

            <button
              onClick={() => {
                if (activeActivities.length === 0) {
                  alert('‚ö†Ô∏è Selecciona al menos 1 actividad');
                  return;
                }
                setCurrentView('home');
              }}
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-6 rounded-2xl font-bold text-xl shadow-lg hover:shadow-2xl transition-all"
            >
              ¬°Empezar! üöÄ
            </button>
          </div>
        </div>
      );
    }
  };

  const HomeView = () => {
    const upcomingDeliveries = deliveries.slice(0, 3);
    const fpActivities = activeActivities
      .map(id => allActivities[id])
      .filter(a => a && a.type.startsWith('fp-'));

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="p-4 space-y-6">
          <div className="bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl shadow-xl p-8 text-white">
            <div className="text-center">
              <div className="text-5xl font-bold mb-2">{formatDate(new Date())}</div>
              <div className="text-3xl font-mono">{currentTime.toLocaleTimeString('es-ES')}</div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {[
              { icon: 'üìÖ', text: 'Hoy', view: 'daily' },
              { icon: 'üïê', text: 'Semana', view: 'weekly' },
              { icon: 'üìö', text: 'Entregas', view: 'deliveries' },
              { icon: 'üìà', text: 'Stats', view: 'stats' }
            ].map(item => (
              <button
                key={item.view}
                onClick={() => setCurrentView(item.view)}
                className="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all"
              >
                <div className="text-5xl mb-3">{item.icon}</div>
                <div className="font-bold text-lg">{item.text}</div>
              </button>
            ))}
          </div>

          {upcomingDeliveries.length > 0 && (
            <div className="bg-white rounded-3xl shadow-xl p-6">
              <h3 className="text-xl font-bold mb-4">Pr√≥ximas Entregas</h3>
              <div className="space-y-3">
                {upcomingDeliveries.map(delivery => {
                  const daysUntil = getDaysUntilDelivery(delivery.date);
                  const isUrgent = daysUntil >= 0 && daysUntil <= 3;
                  
                  return (
                    <div key={delivery.id} className={`p-4 rounded-xl ${isUrgent ? 'bg-red-50 border-2 border-red-500' : 'bg-gray-50'}`}>
                      <div className="font-bold">{allActivities[delivery.subject]?.name}</div>
                      <div className="text-sm text-gray-600">{delivery.description}</div>
                      <div className={`inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${isUrgent ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'}`}>
                        {daysUntil === 0 ? 'Hoy' : daysUntil === 1 ? 'Ma√±ana' : `${daysUntil} d√≠as`}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {fpActivities.length > 0 && (
            <div className="bg-white rounded-3xl shadow-xl p-6">
              <h3 className="text-xl font-bold mb-4">Materias FP Activas</h3>
              <div className="space-y-3">
                {fpActivities.map(activity => {
                  const schedule = hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork';
                  const sched = activity[schedule];
                  
                  return (
                    <div key={activity.id} className="flex items-center gap-3 p-3 rounded-xl bg-gray-50">
                      <div className={`w-4 h-4 rounded-full ${activity.color}`} />
                      <div className="flex-1">
                        <div className="font-semibold">{activity.name}</div>
                        {sched && sched.start !== '' && sched.start !== 'Var' && (
                          <div className="text-sm text-gray-600">{sched.start} - {sched.end}</div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const DailyView = () => {
    const isSunday = currentDate.getDay() === 0;
    const progress = getProgress(currentDate);
    const schedule = hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork';

    const sortedActivities = activeActivities
      .map(id => allActivities[id])
      .filter(a => {
        if (!a) return false;
        if (hasWork && a.onlyNoWork) return false;
        const sched = a[schedule];
        return sched && sched.start !== '' && sched.start !== 'Var';
      })
      .sort((a, b) => {
        const timeA = a[schedule].start;
        const timeB = b[schedule].start;
        return timeA.localeCompare(timeB);
      });

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="sticky top-16 z-30 bg-white border-b-2 shadow-sm p-4">
          <div className="flex items-center justify-between mb-3">
            <button
              onClick={() => setCurrentDate(new Date(currentDate.getTime() - 86400000))}
              className="text-3xl p-2"
            >
              ‚Üê
            </button>
            <div className="text-lg font-bold">{formatDate(currentDate)}</div>
            <button
              onClick={() => setCurrentDate(new Date(currentDate.getTime() + 86400000))}
              className="text-3xl p-2"
            >
              ‚Üí
            </button>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div
              className="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all"
              style={{ width: `${progress}%` }}
            />
          </div>
          <div className="text-center text-sm font-semibold mt-2">Progreso del d√≠a {progress}%</div>
        </div>

        <div className="p-4 space-y-4">
          <div className="bg-orange-100 border-2 border-orange-500 rounded-2xl p-4">
            <div className="text-center">
              <span className="text-2xl">üîî</span>
              <div className="font-semibold mt-2">Sistema de Alarmas Activo</div>
              <div className="text-sm text-gray-600">Recibir√°s notificaciones cuando empiece cada actividad</div>
            </div>
          </div>

          {isSunday ? (
            <div className="bg-green-100 border-2 border-green-500 rounded-3xl p-8 text-center">
              <div className="text-6xl mb-4">üéâ</div>
              <div className="text-2xl font-bold">D√≠a de Descanso</div>
              <div className="text-lg text-gray-600 mt-2">Domingo OFF</div>
            </div>
          ) : (
            <div className="bg-white rounded-3xl shadow-xl p-6">
              <h3 className="text-xl font-bold mb-4">üìÖ Agenda del D√≠a</h3>
              <div className="space-y-3">
                {sortedActivities.map(activity => {
                  const sched = activity[schedule];
                  const completed = isTaskCompleted(activity.id);
                  
                  return (
                    <div
                      key={activity.id}
                      className={`p-4 rounded-xl border-2 transition-all ${completed ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-200'}`}
                    >
                      <div className="flex items-start gap-3">
                        <button
                          onClick={() => toggleTask(activity.id)}
                          className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}
                        >
                          {completed && <span className="text-white font-bold">‚úì</span>}
                        </button>
                        
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="font-bold text-lg">{activity.name}</span>
                            <span className={`${activity.color} text-white px-3 py-1 rounded-full text-sm font-semibold`}>
                              {sched.hours}
                            </span>
                            {activity.boosted && (
                              <span className="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                {activity.originalHours} ‚Üí {sched.hours} üî•
                              </span>
                            )}
                          </div>
                          
                          <div className="flex items-center gap-2 text-gray-600">
                            <span>‚è±Ô∏è</span>
                            <span>{sched.start} - {sched.end}</span>
                          </div>
                          
                          {activity.technique && (
                            <button
                              onClick={() => setTechniqueModal(activity.technique)}
                              className="mt-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-semibold transition-all"
                            >
                              üí° Ver T√©cnica
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const WeeklyView = () => {
    const getWeekDays = () => {
      const days = [];
      const today = new Date();
      const currentDay = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
      
      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);
        days.push(day);
      }
      return days;
    };

    const weekDays = getWeekDays();
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="p-4 space-y-4">
          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h2 className="text-2xl font-bold">Vista Semanal</h2>
            <p className="text-gray-600">Semana del {formatDate(weekDays[0])}</p>
          </div>

          <div className="space-y-3">
            {weekDays.map((day, index) => {
              const isSunday = day.getDay() === 0;
              const isToday = getDateKey(day) === getDateKey(new Date());
              const progress = getProgress(day);
              
              return (
                <div
                  key={index}
                  className={`bg-white rounded-2xl shadow-lg p-6 ${isToday ? 'ring-4 ring-blue-500' : ''}`}
                >
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <div className="font-bold text-lg">{dayNames[day.getDay()]} {day.getDate()}</div>
                      {isToday && <span className="text-sm text-blue-600 font-semibold">Hoy</span>}
                    </div>
                    {isSunday ? (
                      <span className="bg-green-500 text-white px-4 py-2 rounded-full font-semibold">
                        OFF üéâ
                      </span>
                    ) : (
                      <div className="text-3xl font-bold text-blue-600">{progress}%</div>
                    )}
                  </div>
                  
                  {!isSunday && (
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div
                        className="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all"
                        style={{ width: `${progress}%` }}
                      />
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };

  const DeliveriesView = () => {
    const [newDelivery, setNewDelivery] = useState({
      subject: '',
      date: '',
      description: ''
    });

    const fpSubjects = Object.values(allActivities).filter(a => a.type.startsWith('fp-'));

    const handleAdd = (e) => {
      e.preventDefault();
      addDelivery(newDelivery.subject, newDelivery.date, newDelivery.description);
      setNewDelivery({ subject: '', date: '', description: '' });
    };

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="p-4 space-y-6">
          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h2 className="text-2xl font-bold mb-2">Entregas</h2>
            <p className="text-gray-600">Ajustan autom√°ticamente tu horario</p>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">Nueva Entrega</h3>
            <form onSubmit={handleAdd} className="space-y-4">
              <div>
                <label className="block font-semibold mb-2">Materia FP</label>
                <select
                  value={newDelivery.subject}
                  onChange={e => setNewDelivery({...newDelivery, subject: e.target.value})}
                  className="w-full p-3 border-2 rounded-xl bg-white"
                  required
                >
                  <option value="">Selecciona una materia...</option>
                  {fpSubjects.map(subject => (
                    <option key={subject.id} value={subject.id}>{subject.name}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block font-semibold mb-2">Fecha de Entrega</label>
                <input
                  type="date"
                  value={newDelivery.date}
                  onChange={e => setNewDelivery({...newDelivery, date: e.target.value})}
                  className="w-full p-3 border-2 rounded-xl"
                  required
                />
              </div>

              <div>
                <label className="block font-semibold mb-2">Descripci√≥n</label>
                <input
                  type="text"
                  value={newDelivery.description}
                  onChange={e => setNewDelivery({...newDelivery, description: e.target.value})}
                  className="w-full p-3 border-2 rounded-xl"
                  placeholder="Ej: Proyecto final m√≥dulo 2"
                  required
                />
              </div>

              <button
                type="submit"
                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold hover:shadow-lg transition-all"
              >
                + Agregar Entrega
              </button>
            </form>
          </div>

          {deliveries.length > 0 && (
            <div className="bg-white rounded-3xl shadow-xl p-6">
              <h3 className="text-lg font-bold mb-4">Entregas Programadas</h3>
              <div className="space-y-3">
                {deliveries.map(delivery => {
                  const daysUntil = getDaysUntilDelivery(delivery.date);
                  const isUrgent = daysUntil >= 0 && daysUntil <= 3;
                  const activity = allActivities[delivery.subject];
                  
                  // Calcular boost
                  let boostInfo = null;
                  if (isUrgent && activity?.boosted) {
                    const multiplier = activity.boostedMultiplier || 2;
                    const originalHours = parseFloat(activity.originalHours);
                    const newHours = parseFloat(activity[hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork'].hours);
                    const addedHours = newHours - originalHours;
                    boostInfo = {
                      multiplier,
                      original: activity.originalHours,
                      new: activity[hasWork === false ? 'scheduleNoWork' : 'scheduleWithWork'].hours,
                      added: addedHours.toFixed(1)
                    };
                  }
                  
                  return (
                    <div
                      key={delivery.id}
                      className={`p-4 rounded-xl border-2 ${isUrgent ? 'bg-red-50 border-red-500' : 'bg-gray-50 border-gray-200'}`}
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div className="font-bold text-lg">{activity?.name}</div>
                        <button
                          onClick={() => deleteDelivery(delivery.id)}
                          className="text-red-500 text-2xl hover:text-red-700 transition-colors"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                      
                      <div className="text-gray-600 mb-2">{delivery.description}</div>
                      
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="text-sm text-gray-500">
                          üìÖ {delivery.date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}
                        </span>
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          daysUntil < 0 ? 'bg-gray-500 text-white' :
                          daysUntil === 0 ? 'bg-red-600 text-white' :
                          daysUntil === 1 ? 'bg-red-500 text-white' :
                          daysUntil <= 3 ? 'bg-orange-500 text-white' :
                          'bg-blue-500 text-white'
                        }`}>
                          {daysUntil < 0 ? '‚ùå Vencida' : 
                           daysUntil === 0 ? 'üî• HOY' : 
                           daysUntil === 1 ? '‚ö° Ma√±ana' : 
                           `‚è∞ ${daysUntil} d√≠as`}
                        </span>
                      </div>
                      
                      {boostInfo && (
                        <div className="mt-3 p-3 bg-orange-100 border-2 border-orange-500 rounded-lg">
                          <div className="font-bold text-orange-700 mb-1">
                            üî• Horario Ajustado Autom√°ticamente
                          </div>
                          <div className="text-sm text-orange-800">
                            <div>‚Ä¢ Tiempo original: <strong>{boostInfo.original}</strong></div>
                            <div>‚Ä¢ Tiempo ajustado: <strong>{boostInfo.new}</strong> ({boostInfo.multiplier}x)</div>
                            <div>‚Ä¢ Tiempo adicional: <strong>+{boostInfo.added}h</strong></div>
                          </div>
                          <div className="text-xs text-orange-600 mt-2 italic">
                            üí° El horario se restaurar√° autom√°ticamente cuando pase la fecha de entrega
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const StatsView = () => {
    const totalCompleted = Object.values(completedTasks).reduce(
      (sum, tasks) => sum + Object.values(tasks).filter(Boolean).length,
      0
    );

    const last7Days = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      last7Days.push(date);
    }

    const activityStats = activeActivities.map(id => {
      const activity = allActivities[id];
      const completed = Object.values(completedTasks).reduce(
        (sum, tasks) => sum + (tasks[id] ? 1 : 0),
        0
      );
      return { activity, completed };
    }).sort((a, b) => b.completed - a.completed).slice(0, 10);

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="p-4 space-y-6">
          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h2 className="text-2xl font-bold">Estad√≠sticas</h2>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="bg-gradient-to-br from-blue-600 to-blue-400 rounded-2xl shadow-lg p-6 text-white">
              <div className="text-4xl font-bold mb-2">{totalCompleted}</div>
              <div className="text-sm">Tareas Completadas</div>
            </div>
            <div className="bg-gradient-to-br from-purple-600 to-purple-400 rounded-2xl shadow-lg p-6 text-white">
              <div className="text-4xl font-bold mb-2">{deliveries.length}</div>
              <div className="text-sm">Entregas Pendientes</div>
            </div>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">Progreso √öltimos 7 D√≠as</h3>
            <div className="flex items-end justify-between h-40 gap-2">
              {last7Days.map((date, index) => {
                const progress = getProgress(date);
                const dayName = ['D', 'L', 'M', 'X', 'J', 'V', 'S'][date.getDay()];
                
                return (
                  <div key={index} className="flex-1 flex flex-col items-center gap-2">
                    <div className="w-full bg-gradient-to-t from-blue-600 to-purple-600 rounded-t-lg transition-all" style={{ height: `${progress}%` }} />
                    <div className="text-sm font-semibold">{dayName}</div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">Progreso por Actividad</h3>
            <div className="space-y-3">
              {activityStats.map(({ activity, completed }) => (
                <div key={activity.id}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-semibold">{activity.name}</span>
                    <span className="text-gray-600">{completed}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                      className={`${activity.color} h-3 rounded-full transition-all`}
                      style={{ width: `${Math.min(completed * 10, 100)}%` }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const SettingsView = () => {
    const fileInputRef = React.useRef();

    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <TopBar />
        
        <div className="p-4 space-y-6">
          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h2 className="text-2xl font-bold">Configuraci√≥n</h2>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">Situaci√≥n Laboral</h3>
            <div className="mb-4 p-4 bg-gray-50 rounded-xl">
              <div className="font-semibold">
                {hasWork ? 'üîµ Con trabajo (8h)' : 'üü¢ Sin trabajo'}
              </div>
            </div>
            <button
              onClick={() => setHasWork(!hasWork)}
              className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all"
            >
              Cambiar
            </button>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">Gestionar Actividades</h3>
            <div className="max-h-60 overflow-y-auto mb-4 space-y-2">
              {Object.values(allActivities).map(activity => {
                if (hasWork && activity.onlyNoWork) return null;
                
                return (
                  <label
                    key={activity.id}
                    className="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      checked={activeActivities.includes(activity.id)}
                      onChange={() => {
                        setActiveActivities(prev =>
                          prev.includes(activity.id)
                            ? prev.filter(id => id !== activity.id)
                            : [...prev, activity.id]
                        );
                      }}
                      className="w-5 h-5"
                    />
                    <div className={`w-3 h-3 rounded-full ${activity.color}`} />
                    <span className="font-semibold">{activity.name}</span>
                  </label>
                );
              })}
            </div>
            <button
              onClick={() => setAddItemModal(true)}
              className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold transition-all"
            >
              + Agregar √çtem Personalizado
            </button>
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">‚òÅÔ∏è Servicios en la Nube</h3>
            
            {!cloudConnected ? (
              <>
                <p className="text-gray-600 mb-4 text-sm">
                  Conecta un servicio en la nube para respaldar tus datos autom√°ticamente
                </p>
                <div className="space-y-3">
                  <button
                    onClick={() => connectCloudService('google')}
                    className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 py-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-3"
                  >
                    <span className="text-2xl">üìÅ</span>
                    <span>Conectar Google Drive</span>
                  </button>
                  <button
                    onClick={() => connectCloudService('microsoft')}
                    className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 py-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-3"
                  >
                    <span className="text-2xl">‚òÅÔ∏è</span>
                    <span>Conectar OneDrive</span>
                  </button>
                  <button
                    onClick={() => connectCloudService('terabox')}
                    className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 py-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-3"
                  >
                    <span className="text-2xl">üì¶</span>
                    <span>Conectar TeraBox</span>
                  </button>
                </div>
              </>
            ) : (
              <div className="space-y-3">
                <div className="p-4 bg-green-50 border-2 border-green-500 rounded-xl">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-bold text-green-700">
                        ‚úÖ Conectado a {
                          cloudService === 'google' ? 'Google Drive' :
                          cloudService === 'microsoft' ? 'OneDrive' :
                          'TeraBox'
                        }
                      </div>
                      <div className="text-sm text-green-600 mt-1">
                        Tus datos est√°n sincronizados
                      </div>
                    </div>
                  </div>
                </div>
                <button
                  onClick={disconnectCloudService}
                  className="w-full bg-red-100 hover:bg-red-200 text-red-700 py-3 rounded-xl font-semibold transition-all"
                >
                  Desconectar
                </button>
              </div>
            )}
          </div>

          <div className="bg-white rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold mb-4">üíæ Backup & Restauraci√≥n</h3>
            <div className="space-y-3">
              <button
                onClick={downloadBackup}
                className="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2"
              >
                <span>‚¨áÔ∏è</span>
                <span>Descargar Backup (.json)</span>
              </button>
              <label className="block">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".json"
                  onChange={restoreBackup}
                  className="hidden"
                />
                <div className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold text-center cursor-pointer transition-all flex items-center justify-center gap-2">
                  <span>‚¨ÜÔ∏è</span>
                  <span>Restaurar desde Backup</span>
                </div>
              </label>
              <p className="text-sm text-gray-600 text-center">
                üí° Guarda el archivo .json en tu servicio en la nube preferido
              </p>
            </div>
          </div>

          <div className="bg-red-50 border-2 border-red-500 rounded-3xl shadow-xl p-6">
            <h3 className="text-lg font-bold text-red-700 mb-4">‚ö†Ô∏è Zona Peligrosa</h3>
            <button
              onClick={resetApp}
              className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all"
            >
              Reiniciar Configuraci√≥n
            </button>
            <p className="text-sm text-red-600 text-center mt-3">
              ‚ö†Ô∏è Esto borrar√° todos los datos
            </p>
          </div>
        </div>
      </div>
    );
  };

  // ============================================================================
  // RENDER
  // ============================================================================

  return (
    <div className="font-sans">
      {currentView === 'setup' && <SetupView />}
      {currentView === 'home' && <HomeView />}
      {currentView === 'daily' && <DailyView />}
      {currentView === 'weekly' && <WeeklyView />}
      {currentView === 'deliveries' && <DeliveriesView />}
      {currentView === 'stats' && <StatsView />}
      {currentView === 'settings' && <SettingsView />}
      
      <SideMenu />
      <TechniqueModal />
      <AddItemModal />
    </div>
  );
}

        // Renderizar la app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FPDAMGestor />);
    </script>
</body>
</html>
